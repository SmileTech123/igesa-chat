(function(k){"object"===typeof exports&&"undefined"!==typeof module?module.exports=k():"function"===typeof define&&define.amd?define([],k):("undefined"!==typeof window?window:"undefined"!==typeof global?global:"undefined"!==typeof self?self:this).adapter=k()})(function(){return function(){function k(n,f,d){function a(b,e){if(!f[b]){if(!n[b]){var h="function"==typeof require&&require;if(!e&&h)return h(b,!0);if(c)return c(b,!0);h=Error("Cannot find module '"+b+"'");throw h.code="MODULE_NOT_FOUND",h;
}h=f[b]={exports:{}};n[b][0].call(h.exports,function(h){return a(n[b][1][h]||h)},h,h.exports,k,n,f,d)}return f[b].exports}for(var c="function"==typeof require&&require,b=0;b<d.length;b++)a(d[b]);return a}return k}()({1:[function(k,n,f){k=k("./adapter_factory.js");k=(0,k.adapterFactory)({window:window});n.exports=k},{"./adapter_factory.js":2}],2:[function(k,n,f){function d(a){if(a&&a.__esModule)return a;var h={};if(null!=a)for(var b in a)Object.prototype.hasOwnProperty.call(a,b)&&(h[b]=a[b]);h.default=
a;return h}Object.defineProperty(f,"__esModule",{value:!0});f.adapterFactory=function(){var g=(0<arguments.length&&void 0!==arguments[0]?arguments[0]:{}).window,p=1<arguments.length&&void 0!==arguments[1]?arguments[1]:{shimChrome:!0,shimFirefox:!0,shimEdge:!0,shimSafari:!0},d=a.log,C=a.detectBrowser(g),q={browserDetails:C,commonShim:h,extractVersion:a.extractVersion,disableLog:a.disableLog,disableWarnings:a.disableWarnings};switch(C.browser){case "chrome":if(!c||!c.shimPeerConnection||!p.shimChrome){d("Chrome shim is not included in this adapter release.");
break}d("adapter.js shimming chrome.");q.browserShim=c;c.shimGetUserMedia(g);c.shimMediaStream(g);c.shimPeerConnection(g);c.shimOnTrack(g);c.shimAddTrackRemoveTrack(g);c.shimGetSendersWithDtmf(g);c.shimGetStats(g);c.shimSenderReceiverGetStats(g);c.fixNegotiationNeeded(g);h.shimRTCIceCandidate(g);h.shimConnectionState(g);h.shimMaxMessageSize(g);h.shimSendThrowTypeError(g);h.removeAllowExtmapMixed(g);break;case "firefox":if(!l||!l.shimPeerConnection||!p.shimFirefox){d("Firefox shim is not included in this adapter release.");
break}d("adapter.js shimming firefox.");q.browserShim=l;l.shimGetUserMedia(g);l.shimPeerConnection(g);l.shimOnTrack(g);l.shimRemoveStream(g);l.shimSenderGetStats(g);l.shimReceiverGetStats(g);l.shimRTCDataChannel(g);l.shimAddTransceiver(g);l.shimCreateOffer(g);l.shimCreateAnswer(g);h.shimRTCIceCandidate(g);h.shimConnectionState(g);h.shimMaxMessageSize(g);h.shimSendThrowTypeError(g);break;case "edge":if(!b||!b.shimPeerConnection||!p.shimEdge){d("MS edge shim is not included in this adapter release.");
break}d("adapter.js shimming edge.");q.browserShim=b;b.shimGetUserMedia(g);b.shimGetDisplayMedia(g);b.shimPeerConnection(g);b.shimReplaceTrack(g);h.shimMaxMessageSize(g);h.shimSendThrowTypeError(g);break;case "safari":if(!e||!p.shimSafari){d("Safari shim is not included in this adapter release.");break}d("adapter.js shimming safari.");q.browserShim=e;e.shimRTCIceServerUrls(g);e.shimCreateOfferLegacy(g);e.shimCallbacksAPI(g);e.shimLocalStreamsAPI(g);e.shimRemoteStreamsAPI(g);e.shimTrackEventTransceiver(g);
e.shimGetUserMedia(g);h.shimRTCIceCandidate(g);h.shimMaxMessageSize(g);h.shimSendThrowTypeError(g);h.removeAllowExtmapMixed(g);break;default:d("Unsupported browser!")}return q};n=k("./utils");var a=d(n);n=k("./chrome/chrome_shim");var c=d(n);n=k("./edge/edge_shim");var b=d(n);n=k("./firefox/firefox_shim");var l=d(n);n=k("./safari/safari_shim");var e=d(n);k=k("./common_shim");var h=d(k)},{"./chrome/chrome_shim":3,"./common_shim":6,"./edge/edge_shim":7,"./firefox/firefox_shim":11,"./safari/safari_shim":14,
"./utils":15}],3:[function(k,n,f){function d(a,b,e){b in a?Object.defineProperty(a,b,{value:e,enumerable:!0,configurable:!0,writable:!0}):a[b]=e;return a}function a(a){a.RTCPeerConnection.prototype.getLocalStreams=function(){var a=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};return Object.keys(this._shimmedLocalStreams).map(function(h){return a._shimmedLocalStreams[h][0]})};var b=a.RTCPeerConnection.prototype.addTrack;a.RTCPeerConnection.prototype.addTrack=function(a,h){if(!h)return b.apply(this,
arguments);this._shimmedLocalStreams=this._shimmedLocalStreams||{};var e=b.apply(this,arguments);this._shimmedLocalStreams[h.id]?-1===this._shimmedLocalStreams[h.id].indexOf(e)&&this._shimmedLocalStreams[h.id].push(e):this._shimmedLocalStreams[h.id]=[h,e];return e};var e=a.RTCPeerConnection.prototype.addStream;a.RTCPeerConnection.prototype.addStream=function(a){var h=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};a.getTracks().forEach(function(a){if(h.getSenders().find(function(h){return h.track===
a}))throw new DOMException("Track already exists.","InvalidAccessError");});var b=this.getSenders();e.apply(this,arguments);var u=this.getSenders().filter(function(a){return-1===b.indexOf(a)});this._shimmedLocalStreams[a.id]=[a].concat(u)};var c=a.RTCPeerConnection.prototype.removeStream;a.RTCPeerConnection.prototype.removeStream=function(a){this._shimmedLocalStreams=this._shimmedLocalStreams||{};delete this._shimmedLocalStreams[a.id];return c.apply(this,arguments)};var C=a.RTCPeerConnection.prototype.removeTrack;
a.RTCPeerConnection.prototype.removeTrack=function(a){var h=this;this._shimmedLocalStreams=this._shimmedLocalStreams||{};a&&Object.keys(this._shimmedLocalStreams).forEach(function(b){var e=h._shimmedLocalStreams[b].indexOf(a);-1!==e&&h._shimmedLocalStreams[b].splice(e,1);1===h._shimmedLocalStreams[b].length&&delete h._shimmedLocalStreams[b]});return C.apply(this,arguments)}}Object.defineProperty(f,"__esModule",{value:!0});f.shimGetDisplayMedia=f.shimGetUserMedia=void 0;var c="function"===typeof Symbol&&
"symbol"===typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"===typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a},b=k("./getusermedia");Object.defineProperty(f,"shimGetUserMedia",{enumerable:!0,get:function(){return b.shimGetUserMedia}});var l=k("./getdisplaymedia");Object.defineProperty(f,"shimGetDisplayMedia",{enumerable:!0,get:function(){return l.shimGetDisplayMedia}});f.shimMediaStream=function(a){a.MediaStream=a.MediaStream||a.webkitMediaStream};
f.shimOnTrack=function(a){if("object"===("undefined"===typeof a?"undefined":c(a))&&a.RTCPeerConnection&&!("ontrack"in a.RTCPeerConnection.prototype)){Object.defineProperty(a.RTCPeerConnection.prototype,"ontrack",{get:function(){return this._ontrack},set:function(a){this._ontrack&&this.removeEventListener("track",this._ontrack);this.addEventListener("track",this._ontrack=a)},enumerable:!0,configurable:!0});var b=a.RTCPeerConnection.prototype.setRemoteDescription;a.RTCPeerConnection.prototype.setRemoteDescription=
function(){var e=this;this._ontrackpoly||(this._ontrackpoly=function(b){b.stream.addEventListener("addtrack",function(g){var c=void 0,c=a.RTCPeerConnection.prototype.getReceivers?e.getReceivers().find(function(a){return a.track&&a.track.id===g.track.id}):{track:g.track},d=new Event("track");d.track=g.track;d.receiver=c;d.transceiver={receiver:c};d.streams=[b.stream];e.dispatchEvent(d)});b.stream.getTracks().forEach(function(g){var c=void 0,c=a.RTCPeerConnection.prototype.getReceivers?e.getReceivers().find(function(a){return a.track&&
a.track.id===g.id}):{track:g},d=new Event("track");d.track=g;d.receiver=c;d.transceiver={receiver:c};d.streams=[b.stream];e.dispatchEvent(d)})},this.addEventListener("addstream",this._ontrackpoly));return b.apply(this,arguments)}}else e.wrapPeerConnectionEvent(a,"track",function(a){a.transceiver||Object.defineProperty(a,"transceiver",{value:{receiver:a.receiver}});return a})};f.shimGetSendersWithDtmf=function(a){if("object"===("undefined"===typeof a?"undefined":c(a))&&a.RTCPeerConnection&&!("getSenders"in
a.RTCPeerConnection.prototype)&&"createDTMFSender"in a.RTCPeerConnection.prototype){var b=function(a,b){return{track:b,get dtmf(){void 0===this._dtmf&&(this._dtmf="audio"===b.kind?a.createDTMFSender(b):null);return this._dtmf},_pc:a}};if(!a.RTCPeerConnection.prototype.getSenders){a.RTCPeerConnection.prototype.getSenders=function(){this._senders=this._senders||[];return this._senders.slice()};var e=a.RTCPeerConnection.prototype.addTrack;a.RTCPeerConnection.prototype.addTrack=function(a,h){var A=e.apply(this,
arguments);A||(A=b(this,a),this._senders.push(A));return A};var d=a.RTCPeerConnection.prototype.removeTrack;a.RTCPeerConnection.prototype.removeTrack=function(a){d.apply(this,arguments);var b=this._senders.indexOf(a);-1!==b&&this._senders.splice(b,1)}}var C=a.RTCPeerConnection.prototype.addStream;a.RTCPeerConnection.prototype.addStream=function(a){var e=this;this._senders=this._senders||[];C.apply(this,[a]);a.getTracks().forEach(function(a){e._senders.push(b(e,a))})};var l=a.RTCPeerConnection.prototype.removeStream;
a.RTCPeerConnection.prototype.removeStream=function(a){var b=this;this._senders=this._senders||[];l.apply(this,[a]);a.getTracks().forEach(function(a){var e=b._senders.find(function(b){return b.track===a});e&&b._senders.splice(b._senders.indexOf(e),1)})}}else if("object"===("undefined"===typeof a?"undefined":c(a))&&a.RTCPeerConnection&&"getSenders"in a.RTCPeerConnection.prototype&&"createDTMFSender"in a.RTCPeerConnection.prototype&&a.RTCRtpSender&&!("dtmf"in a.RTCRtpSender.prototype)){var m=a.RTCPeerConnection.prototype.getSenders;
a.RTCPeerConnection.prototype.getSenders=function(){var a=this,b=m.apply(this,[]);b.forEach(function(b){return b._pc=a});return b};Object.defineProperty(a.RTCRtpSender.prototype,"dtmf",{get:function(){void 0===this._dtmf&&(this._dtmf="audio"===this.track.kind?this._pc.createDTMFSender(this.track):null);return this._dtmf}})}};f.shimGetStats=function(a){if(a.RTCPeerConnection){var b=a.RTCPeerConnection.prototype.getStats;a.RTCPeerConnection.prototype.getStats=function(){var a=this,e=Array.prototype.slice.call(arguments),
h=e[0],c=e[1],e=e[2];if(0<arguments.length&&"function"===typeof h)return b.apply(this,arguments);if(0===b.length&&(0===arguments.length||"function"!==typeof h))return b.apply(this,[]);var d=function(a){var b={};a.result().forEach(function(a){var e={id:a.id,timestamp:a.timestamp,type:{localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[a.type]||a.type};a.names().forEach(function(b){e[b]=a.stat(b)});b[e.id]=e});return b},l=function(a){return new Map(Object.keys(a).map(function(b){return[b,
a[b]]}))};return 2<=arguments.length?b.apply(this,[function(a){c(l(d(a)))},h]):(new Promise(function(e,h){b.apply(a,[function(a){e(l(d(a)))},h])})).then(c,e)}}};f.shimSenderReceiverGetStats=function(a){if("object"===("undefined"===typeof a?"undefined":c(a))&&a.RTCPeerConnection&&a.RTCRtpSender&&a.RTCRtpReceiver){if(!("getStats"in a.RTCRtpSender.prototype)){var b=a.RTCPeerConnection.prototype.getSenders;b&&(a.RTCPeerConnection.prototype.getSenders=function(){var a=this,e=b.apply(this,[]);e.forEach(function(b){return b._pc=
a});return e});var d=a.RTCPeerConnection.prototype.addTrack;d&&(a.RTCPeerConnection.prototype.addTrack=function(){var a=d.apply(this,arguments);a._pc=this;return a});a.RTCRtpSender.prototype.getStats=function(){var a=this;return this._pc.getStats().then(function(b){return e.filterStats(b,a.track,!0)})}}if(!("getStats"in a.RTCRtpReceiver.prototype)){var l=a.RTCPeerConnection.prototype.getReceivers;l&&(a.RTCPeerConnection.prototype.getReceivers=function(){var a=this,b=l.apply(this,[]);b.forEach(function(b){return b._pc=
a});return b});e.wrapPeerConnectionEvent(a,"track",function(a){a.receiver._pc=a.srcElement;return a});a.RTCRtpReceiver.prototype.getStats=function(){var a=this;return this._pc.getStats().then(function(b){return e.filterStats(b,a.track,!1)})}}if("getStats"in a.RTCRtpSender.prototype&&"getStats"in a.RTCRtpReceiver.prototype){var C=a.RTCPeerConnection.prototype.getStats;a.RTCPeerConnection.prototype.getStats=function(){if(0<arguments.length&&arguments[0]instanceof a.MediaStreamTrack){var b=arguments[0],
e=void 0,g=void 0,c=void 0;this.getSenders().forEach(function(a){a.track===b&&(e?c=!0:e=a)});this.getReceivers().forEach(function(a){a.track===b&&(g?c=!0:g=a);return a.track===b});return c||e&&g?Promise.reject(new DOMException("There are more than one sender or receiver for the track.","InvalidAccessError")):e?e.getStats():g?g.getStats():Promise.reject(new DOMException("There is no sender or receiver for the track.","InvalidAccessError"))}return C.apply(this,arguments)}}}};f.shimAddTrackRemoveTrackWithNative=
a;f.shimAddTrackRemoveTrack=function(b){function g(a,b){var e=b.sdp;Object.keys(a._reverseStreams||[]).forEach(function(b){b=a._reverseStreams[b];e=e.replace(RegExp(a._streams[b.id].id,"g"),b.id)});return new RTCSessionDescription({type:b.type,sdp:e})}function c(a,b){var e=b.sdp;Object.keys(a._reverseStreams||[]).forEach(function(b){b=a._reverseStreams[b];e=e.replace(RegExp(b.id,"g"),a._streams[b.id].id)});return new RTCSessionDescription({type:b.type,sdp:e})}if(b.RTCPeerConnection){var l=e.detectBrowser(b);
if(b.RTCPeerConnection.prototype.addTrack&&65<=l.version)return a(b);var C=b.RTCPeerConnection.prototype.getLocalStreams;b.RTCPeerConnection.prototype.getLocalStreams=function(){var a=this,b=C.apply(this);this._reverseStreams=this._reverseStreams||{};return b.map(function(b){return a._reverseStreams[b.id]})};var q=b.RTCPeerConnection.prototype.addStream;b.RTCPeerConnection.prototype.addStream=function(a){var e=this;this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};a.getTracks().forEach(function(a){if(e.getSenders().find(function(b){return b.track===
a}))throw new DOMException("Track already exists.","InvalidAccessError");});if(!this._reverseStreams[a.id]){var g=new b.MediaStream(a.getTracks());this._streams[a.id]=g;this._reverseStreams[g.id]=a;a=g}q.apply(this,[a])};var m=b.RTCPeerConnection.prototype.removeStream;b.RTCPeerConnection.prototype.removeStream=function(a){this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};m.apply(this,[this._streams[a.id]||a]);delete this._reverseStreams[this._streams[a.id]?this._streams[a.id].id:
a.id];delete this._streams[a.id]};b.RTCPeerConnection.prototype.addTrack=function(a,e){var g=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");var c=[].slice.call(arguments,1);if(1!==c.length||!c[0].getTracks().find(function(b){return b===a}))throw new DOMException("The adapter.js addTrack polyfill only supports a single  stream which is associated with the specified track.","NotSupportedError");if(this.getSenders().find(function(b){return b.track===
a}))throw new DOMException("Track already exists.","InvalidAccessError");this._streams=this._streams||{};this._reverseStreams=this._reverseStreams||{};(c=this._streams[e.id])?(c.addTrack(a),Promise.resolve().then(function(){g.dispatchEvent(new Event("negotiationneeded"))})):(c=new b.MediaStream([a]),this._streams[e.id]=c,this._reverseStreams[c.id]=e,this.addStream(c));return this.getSenders().find(function(b){return b.track===a})};["createOffer","createAnswer"].forEach(function(a){var e=b.RTCPeerConnection.prototype[a],
c=d({},a,function(){var a=this,b=arguments;return arguments.length&&"function"===typeof arguments[0]?e.apply(this,[function(e){e=g(a,e);b[0].apply(null,[e])},function(a){b[1]&&b[1].apply(null,a)},arguments[2]]):e.apply(this,arguments).then(function(b){return g(a,b)})});b.RTCPeerConnection.prototype[a]=c[a]});var f=b.RTCPeerConnection.prototype.setLocalDescription;b.RTCPeerConnection.prototype.setLocalDescription=function(){if(!arguments.length||!arguments[0].type)return f.apply(this,arguments);arguments[0]=
c(this,arguments[0]);return f.apply(this,arguments)};var u=Object.getOwnPropertyDescriptor(b.RTCPeerConnection.prototype,"localDescription");Object.defineProperty(b.RTCPeerConnection.prototype,"localDescription",{get:function(){var a=u.get.apply(this);return""===a.type?a:g(this,a)}});b.RTCPeerConnection.prototype.removeTrack=function(a){var b=this;if("closed"===this.signalingState)throw new DOMException("The RTCPeerConnection's signalingState is 'closed'.","InvalidStateError");if(!a._pc)throw new DOMException("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.",
"TypeError");if(a._pc!==this)throw new DOMException("Sender was not created by this connection.","InvalidAccessError");this._streams=this._streams||{};var e=void 0;Object.keys(this._streams).forEach(function(g){b._streams[g].getTracks().find(function(b){return a.track===b})&&(e=b._streams[g])});e&&(1===e.getTracks().length?this.removeStream(this._reverseStreams[e.id]):e.removeTrack(a.track),this.dispatchEvent(new Event("negotiationneeded")))}}};f.shimPeerConnection=function(a){var b=e.detectBrowser(a);
!a.RTCPeerConnection&&a.webkitRTCPeerConnection&&(a.RTCPeerConnection=a.webkitRTCPeerConnection);if(a.RTCPeerConnection){var c=0===a.RTCPeerConnection.prototype.addIceCandidate.length;53>b.version&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(b){var e=a.RTCPeerConnection.prototype[b],g=d({},b,function(){arguments[0]=new ("addIceCandidate"===b?a.RTCIceCandidate:a.RTCSessionDescription)(arguments[0]);return e.apply(this,arguments)});a.RTCPeerConnection.prototype[b]=
g[b]});var l=a.RTCPeerConnection.prototype.addIceCandidate;a.RTCPeerConnection.prototype.addIceCandidate=function(){return!c&&!arguments[0]?(arguments[1]&&arguments[1].apply(null),Promise.resolve()):78>b.version&&arguments[0]&&""===arguments[0].candidate?Promise.resolve():l.apply(this,arguments)}}};f.fixNegotiationNeeded=function(a){e.wrapPeerConnectionEvent(a,"negotiationneeded",function(a){if("stable"===a.target.signalingState)return a})};var e=function(a){if(a&&a.__esModule)return a;var b={};if(null!=
a)for(var e in a)Object.prototype.hasOwnProperty.call(a,e)&&(b[e]=a[e]);b.default=a;return b}(k("../utils.js"))},{"../utils.js":15,"./getdisplaymedia":4,"./getusermedia":5}],4:[function(k,n,f){Object.defineProperty(f,"__esModule",{value:!0});f.shimGetDisplayMedia=function(d,a){!(d.navigator.mediaDevices&&"getDisplayMedia"in d.navigator.mediaDevices)&&d.navigator.mediaDevices&&("function"!==typeof a?console.error("shimGetDisplayMedia: getSourceId argument is not a function"):d.navigator.mediaDevices.getDisplayMedia=
function(c){return a(c).then(function(a){var l=c.video&&c.video.width,e=c.video&&c.video.height;c.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:a,maxFrameRate:c.video&&c.video.frameRate||3}};l&&(c.video.mandatory.maxWidth=l);e&&(c.video.mandatory.maxHeight=e);return d.navigator.mediaDevices.getUserMedia(c)})})}},{}],5:[function(k,n,f){Object.defineProperty(f,"__esModule",{value:!0});var d="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(a){return typeof a}:
function(a){return a&&"function"===typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};f.shimGetUserMedia=function(b){var l=b&&b.navigator;if(l.mediaDevices){var e=a.detectBrowser(b),h=function(a){if("object"!==("undefined"===typeof a?"undefined":d(a))||a.mandatory||a.optional)return a;var b={};Object.keys(a).forEach(function(e){if(!("require"===e||"advanced"===e||"mediaSource"===e)){var g="object"===d(a[e])?a[e]:{ideal:a[e]};void 0!==g.exact&&"number"===typeof g.exact&&
(g.min=g.max=g.exact);var c=function(a,b){return a?a+b.charAt(0).toUpperCase()+b.slice(1):"deviceId"===b?"sourceId":b};if(void 0!==g.ideal){b.optional=b.optional||[];var A={};"number"===typeof g.ideal?(A[c("min",e)]=g.ideal,b.optional.push(A),A={},A[c("max",e)]=g.ideal):A[c("",e)]=g.ideal;b.optional.push(A)}void 0!==g.exact&&"number"!==typeof g.exact?(b.mandatory=b.mandatory||{},b.mandatory[c("",e)]=g.exact):["min","max"].forEach(function(a){void 0!==g[a]&&(b.mandatory=b.mandatory||{},b.mandatory[c(a,
e)]=g[a])})}});a.advanced&&(b.optional=(b.optional||[]).concat(a.advanced));return b},g=function(a,b){if(61<=e.version)return b(a);if((a=JSON.parse(JSON.stringify(a)))&&"object"===d(a.audio)){var g=function(a,b,e){b in a&&!(e in a)&&(a[e]=a[b],delete a[b])};a=JSON.parse(JSON.stringify(a));g(a.audio,"autoGainControl","googAutoGainControl");g(a.audio,"noiseSuppression","googNoiseSuppression");a.audio=h(a.audio)}if(a&&"object"===d(a.video)){var p=a.video.facingMode,p=p&&("object"===("undefined"===typeof p?
"undefined":d(p))?p:{ideal:p}),g=66>e.version;if(p&&("user"===p.exact||"environment"===p.exact||"user"===p.ideal||"environment"===p.ideal)&&(!l.mediaDevices.getSupportedConstraints||!l.mediaDevices.getSupportedConstraints().facingMode||g)){delete a.video.facingMode;var u=void 0;if("environment"===p.exact||"environment"===p.ideal)u=["back","rear"];else if("user"===p.exact||"user"===p.ideal)u=["front"];if(u)return l.mediaDevices.enumerateDevices().then(function(e){e=e.filter(function(a){return"videoinput"===
a.kind});var g=e.find(function(a){return u.some(function(b){return a.label.toLowerCase().includes(b)})});!g&&(e.length&&u.includes("back"))&&(g=e[e.length-1]);g&&(a.video.deviceId=p.exact?{exact:g.deviceId}:{ideal:g.deviceId});a.video=h(a.video);c("chrome: "+JSON.stringify(a));return b(a)})}a.video=h(a.video)}c("chrome: "+JSON.stringify(a));return b(a)},p=function(a){return 64<=e.version?a:{name:{PermissionDeniedError:"NotAllowedError",PermissionDismissedError:"NotAllowedError",InvalidStateError:"NotAllowedError",
DevicesNotFoundError:"NotFoundError",ConstraintNotSatisfiedError:"OverconstrainedError",TrackStartError:"NotReadableError",MediaDeviceFailedDueToShutdown:"NotAllowedError",MediaDeviceKillSwitchOn:"NotAllowedError",TabCaptureError:"AbortError",ScreenCaptureError:"AbortError",DeviceCaptureError:"AbortError"}[a.name]||a.name,message:a.message,constraint:a.constraint||a.constraintName,toString:function(){return this.name+(this.message&&": ")+this.message}}};l.getUserMedia=function(a,b,e){g(a,function(a){l.webkitGetUserMedia(a,
b,function(a){e&&e(p(a))})})}.bind(l);if(l.mediaDevices.getUserMedia){var N=l.mediaDevices.getUserMedia.bind(l.mediaDevices);l.mediaDevices.getUserMedia=function(a){return g(a,function(a){return N(a).then(function(b){if(a.audio&&!b.getAudioTracks().length||a.video&&!b.getVideoTracks().length)throw b.getTracks().forEach(function(a){a.stop()}),new DOMException("","NotFoundError");return b},function(a){return Promise.reject(p(a))})})}}}};var a=function(a){if(a&&a.__esModule)return a;var c={};if(null!=
a)for(var e in a)Object.prototype.hasOwnProperty.call(a,e)&&(c[e]=a[e]);c.default=a;return c}(k("../utils.js")),c=a.log},{"../utils.js":15}],6:[function(k,n,f){Object.defineProperty(f,"__esModule",{value:!0});var d="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"===typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};f.shimRTCIceCandidate=function(b){if(b.RTCIceCandidate&&!(b.RTCIceCandidate&&"foundation"in
b.RTCIceCandidate.prototype)){var l=b.RTCIceCandidate;b.RTCIceCandidate=function(b){if("object"===("undefined"===typeof b?"undefined":d(b))&&b.candidate&&0===b.candidate.indexOf("a="))b=JSON.parse(JSON.stringify(b)),b.candidate=b.candidate.substr(2);if(b.candidate&&b.candidate.length){var c=new l(b);b=a.default.parseCandidate(b.candidate);var g=Object.assign(c,b);g.toJSON=function(){return{candidate:g.candidate,sdpMid:g.sdpMid,sdpMLineIndex:g.sdpMLineIndex,usernameFragment:g.usernameFragment}};return g}return new l(b)};
b.RTCIceCandidate.prototype=l.prototype;c.wrapPeerConnectionEvent(b,"icecandidate",function(a){a.candidate&&Object.defineProperty(a,"candidate",{value:new b.RTCIceCandidate(a.candidate),writable:"false"});return a})}};f.shimMaxMessageSize=function(b){if(b.RTCPeerConnection){var d=c.detectBrowser(b);"sctp"in b.RTCPeerConnection.prototype||Object.defineProperty(b.RTCPeerConnection.prototype,"sctp",{get:function(){return"undefined"===typeof this._sctp?null:this._sctp}});var e=function(b){if(!b||!b.sdp)return!1;
b=a.default.splitSections(b.sdp);b.shift();return b.some(function(b){return(b=a.default.parseMLine(b))&&"application"===b.kind&&-1!==b.protocol.indexOf("SCTP")})},h=function(a){a=a.sdp.match(/mozilla...THIS_IS_SDPARTA-(\d+)/);if(null===a||2>a.length)return-1;a=parseInt(a[1],10);return a!==a?-1:a},g=function(a){var b=65536;"firefox"===d.browser&&(b=57>d.version?-1===a?16384:2147483637:60>d.version?57===d.version?65535:65536:2147483637);return b},p=function(b,e){var g=65536;"firefox"===d.browser&&57===
d.version&&(g=65535);var c=a.default.matchPrefix(b.sdp,"a=max-message-size:");0<c.length?g=parseInt(c[0].substr(19),10):"firefox"===d.browser&&-1!==e&&(g=2147483637);return g},N=b.RTCPeerConnection.prototype.setRemoteDescription;b.RTCPeerConnection.prototype.setRemoteDescription=function(){this._sctp=null;"chrome"===d.browser&&76<=d.version&&"plan-b"===this.getConfiguration().sdpSemantics&&Object.defineProperty(this,"sctp",{get:function(){return"undefined"===typeof this._sctp?null:this._sctp},enumerable:!0,
configurable:!0});if(e(arguments[0])){var a=h(arguments[0]),b=g(a),a=p(arguments[0],a),c=void 0,c=0===b&&0===a?Number.POSITIVE_INFINITY:0===b||0===a?Math.max(b,a):Math.min(b,a),b={};Object.defineProperty(b,"maxMessageSize",{get:function(){return c}});this._sctp=b}return N.apply(this,arguments)}}};f.shimSendThrowTypeError=function(a){function d(a,b){var e=a.send;a.send=function(){var c=arguments[0],c=c.length||c.size||c.byteLength;if("open"===a.readyState&&b.sctp&&c>b.sctp.maxMessageSize)throw new TypeError("Message too large (can send a maximum of "+
b.sctp.maxMessageSize+" bytes)");return e.apply(a,arguments)}}if(a.RTCPeerConnection&&"createDataChannel"in a.RTCPeerConnection.prototype){var e=a.RTCPeerConnection.prototype.createDataChannel;a.RTCPeerConnection.prototype.createDataChannel=function(){var a=e.apply(this,arguments);d(a,this);return a};c.wrapPeerConnectionEvent(a,"datachannel",function(a){d(a.channel,a.target);return a})}};f.shimConnectionState=function(a){if(a.RTCPeerConnection&&!("connectionState"in a.RTCPeerConnection.prototype)){var c=
a.RTCPeerConnection.prototype;Object.defineProperty(c,"connectionState",{get:function(){return{completed:"connected",checking:"connecting"}[this.iceConnectionState]||this.iceConnectionState},enumerable:!0,configurable:!0});Object.defineProperty(c,"onconnectionstatechange",{get:function(){return this._onconnectionstatechange||null},set:function(a){this._onconnectionstatechange&&(this.removeEventListener("connectionstatechange",this._onconnectionstatechange),delete this._onconnectionstatechange);a&&
this.addEventListener("connectionstatechange",this._onconnectionstatechange=a)},enumerable:!0,configurable:!0});["setLocalDescription","setRemoteDescription"].forEach(function(a){var b=c[a];c[a]=function(){this._connectionstatechangepoly||(this._connectionstatechangepoly=function(a){var b=a.target;if(b._lastConnectionState!==b.connectionState){b._lastConnectionState=b.connectionState;var e=new Event("connectionstatechange",a);b.dispatchEvent(e)}return a},this.addEventListener("iceconnectionstatechange",
this._connectionstatechangepoly));return b.apply(this,arguments)}})}};f.removeAllowExtmapMixed=function(a){if(a.RTCPeerConnection){var d=c.detectBrowser(a);if(!("chrome"===d.browser&&71<=d.version)){var e=a.RTCPeerConnection.prototype.setRemoteDescription;a.RTCPeerConnection.prototype.setRemoteDescription=function(a){a&&(a.sdp&&-1!==a.sdp.indexOf("\na=extmap-allow-mixed"))&&(a.sdp=a.sdp.split("\n").filter(function(a){return"a=extmap-allow-mixed"!==a.trim()}).join("\n"));return e.apply(this,arguments)}}}};
var a=(n=k("sdp"))&&n.__esModule?n:{"default":n},c=function(a){if(a&&a.__esModule)return a;var c={};if(null!=a)for(var e in a)Object.prototype.hasOwnProperty.call(a,e)&&(c[e]=a[e]);c.default=a;return c}(k("./utils"))},{"./utils":15,sdp:17}],7:[function(k,n,f){Object.defineProperty(f,"__esModule",{value:!0});f.shimGetDisplayMedia=f.shimGetUserMedia=void 0;var d=k("./getusermedia");Object.defineProperty(f,"shimGetUserMedia",{enumerable:!0,get:function(){return d.shimGetUserMedia}});var a=k("./getdisplaymedia");
Object.defineProperty(f,"shimGetDisplayMedia",{enumerable:!0,get:function(){return a.shimGetDisplayMedia}});f.shimPeerConnection=function(a){var d=c.detectBrowser(a);if(a.RTCIceGatherer&&(a.RTCIceCandidate||(a.RTCIceCandidate=function(a){return a}),a.RTCSessionDescription||(a.RTCSessionDescription=function(a){return a}),15025>d.version)){var g=Object.getOwnPropertyDescriptor(a.MediaStreamTrack.prototype,"enabled");Object.defineProperty(a.MediaStreamTrack.prototype,"enabled",{set:function(a){g.set.call(this,
a);var b=new Event("enabled");b.enabled=a;this.dispatchEvent(b)}})}a.RTCRtpSender&&!("dtmf"in a.RTCRtpSender.prototype)&&Object.defineProperty(a.RTCRtpSender.prototype,"dtmf",{get:function(){void 0===this._dtmf&&("audio"===this.track.kind?this._dtmf=new a.RTCDtmfSender(this):"video"===this.track.kind&&(this._dtmf=null));return this._dtmf}});a.RTCDtmfSender&&!a.RTCDTMFSender&&(a.RTCDTMFSender=a.RTCDtmfSender);var p=(0,l.default)(a,d.version);a.RTCPeerConnection=function(a){a&&a.iceServers&&(a.iceServers=
(0,b.filterIceServers)(a.iceServers,d.version),c.log("ICE servers after filtering:",a.iceServers));return new p(a)};a.RTCPeerConnection.prototype=p.prototype};f.shimReplaceTrack=function(a){a.RTCRtpSender&&!("replaceTrack"in a.RTCRtpSender.prototype)&&(a.RTCRtpSender.prototype.replaceTrack=a.RTCRtpSender.prototype.setTrack)};var c=function(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);b.default=a;return b}(k("../utils")),b=
k("./filtericeservers"),l=(k=k("rtcpeerconnection-shim"))&&k.__esModule?k:{"default":k}},{"../utils":15,"./filtericeservers":8,"./getdisplaymedia":9,"./getusermedia":10,"rtcpeerconnection-shim":16}],8:[function(k,n,f){Object.defineProperty(f,"__esModule",{value:!0});f.filterIceServers=function(a,c){var b=!1;a=JSON.parse(JSON.stringify(a));return a.filter(function(a){if(a&&(a.urls||a.url)){var e=a.urls||a.url;a.url&&!a.urls&&d.deprecated("RTCIceServer.url","RTCIceServer.urls");var c="string"===typeof e;
c&&(e=[e]);e=e.filter(function(a){return 0===a.indexOf("stun:")?!1:(a=a.startsWith("turn")&&!a.startsWith("turn:[")&&a.includes("transport=udp"))&&!b?b=!0:a&&!b});delete a.url;a.urls=c?e[0]:e;return!!e.length}})};var d=function(a){if(a&&a.__esModule)return a;var c={};if(null!=a)for(var b in a)Object.prototype.hasOwnProperty.call(a,b)&&(c[b]=a[b]);c.default=a;return c}(k("../utils"))},{"../utils":15}],9:[function(k,n,f){Object.defineProperty(f,"__esModule",{value:!0});f.shimGetDisplayMedia=function(d){"getDisplayMedia"in
d.navigator&&(d.navigator.mediaDevices&&!(d.navigator.mediaDevices&&"getDisplayMedia"in d.navigator.mediaDevices))&&(d.navigator.mediaDevices.getDisplayMedia=d.navigator.getDisplayMedia.bind(d.navigator))}},{}],10:[function(k,n,f){Object.defineProperty(f,"__esModule",{value:!0});f.shimGetUserMedia=function(d){d=d&&d.navigator;var a=function(a){return{name:{PermissionDeniedError:"NotAllowedError"}[a.name]||a.name,message:a.message,constraint:a.constraint,toString:function(){return this.name}}},c=d.mediaDevices.getUserMedia.bind(d.mediaDevices);
d.mediaDevices.getUserMedia=function(b){return c(b).catch(function(b){return Promise.reject(a(b))})}}},{}],11:[function(k,n,f){function d(a,b,c){b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c;return a}Object.defineProperty(f,"__esModule",{value:!0});f.shimGetDisplayMedia=f.shimGetUserMedia=void 0;var a="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"===typeof Symbol&&a.constructor===
Symbol&&a!==Symbol.prototype?"symbol":typeof a},c=k("./getusermedia");Object.defineProperty(f,"shimGetUserMedia",{enumerable:!0,get:function(){return c.shimGetUserMedia}});var b=k("./getdisplaymedia");Object.defineProperty(f,"shimGetDisplayMedia",{enumerable:!0,get:function(){return b.shimGetDisplayMedia}});f.shimOnTrack=function(b){"object"===("undefined"===typeof b?"undefined":a(b))&&(b.RTCTrackEvent&&"receiver"in b.RTCTrackEvent.prototype&&!("transceiver"in b.RTCTrackEvent.prototype))&&Object.defineProperty(b.RTCTrackEvent.prototype,
"transceiver",{get:function(){return{receiver:this.receiver}}})};f.shimPeerConnection=function(b){var c=l.detectBrowser(b);if(!("object"!==("undefined"===typeof b?"undefined":a(b))||!b.RTCPeerConnection&&!b.mozRTCPeerConnection)){!b.RTCPeerConnection&&b.mozRTCPeerConnection&&(b.RTCPeerConnection=b.mozRTCPeerConnection);53>c.version&&["setLocalDescription","setRemoteDescription","addIceCandidate"].forEach(function(a){var c=b.RTCPeerConnection.prototype[a],g=d({},a,function(){arguments[0]=new ("addIceCandidate"===
a?b.RTCIceCandidate:b.RTCSessionDescription)(arguments[0]);return c.apply(this,arguments)});b.RTCPeerConnection.prototype[a]=g[a]});if(68>c.version){var g=b.RTCPeerConnection.prototype.addIceCandidate;b.RTCPeerConnection.prototype.addIceCandidate=function(){return!arguments[0]?(arguments[1]&&arguments[1].apply(null),Promise.resolve()):arguments[0]&&""===arguments[0].candidate?Promise.resolve():g.apply(this,arguments)}}var p={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",candidatepair:"candidate-pair",
localcandidate:"local-candidate",remotecandidate:"remote-candidate"},N=b.RTCPeerConnection.prototype.getStats;b.RTCPeerConnection.prototype.getStats=function(){var a=Array.prototype.slice.call(arguments),b=a[1],e=a[2];return N.apply(this,[a[0]||null]).then(function(a){if(53>c.version&&!b)try{a.forEach(function(a){a.type=p[a.type]||a.type})}catch(e){if("TypeError"!==e.name)throw e;a.forEach(function(b,c){a.set(c,Object.assign({},b,{type:p[b.type]||b.type}))})}return a}).then(b,e)}}};f.shimSenderGetStats=
function(b){if("object"===("undefined"===typeof b?"undefined":a(b))&&(b.RTCPeerConnection&&b.RTCRtpSender)&&!(b.RTCRtpSender&&"getStats"in b.RTCRtpSender.prototype)){var c=b.RTCPeerConnection.prototype.getSenders;c&&(b.RTCPeerConnection.prototype.getSenders=function(){var a=this,b=c.apply(this,[]);b.forEach(function(b){return b._pc=a});return b});var g=b.RTCPeerConnection.prototype.addTrack;g&&(b.RTCPeerConnection.prototype.addTrack=function(){var a=g.apply(this,arguments);a._pc=this;return a});b.RTCRtpSender.prototype.getStats=
function(){return this.track?this._pc.getStats(this.track):Promise.resolve(new Map)}}};f.shimReceiverGetStats=function(b){if("object"===("undefined"===typeof b?"undefined":a(b))&&(b.RTCPeerConnection&&b.RTCRtpSender)&&!(b.RTCRtpSender&&"getStats"in b.RTCRtpReceiver.prototype)){var c=b.RTCPeerConnection.prototype.getReceivers;c&&(b.RTCPeerConnection.prototype.getReceivers=function(){var a=this,b=c.apply(this,[]);b.forEach(function(b){return b._pc=a});return b});l.wrapPeerConnectionEvent(b,"track",
function(a){a.receiver._pc=a.srcElement;return a});b.RTCRtpReceiver.prototype.getStats=function(){return this._pc.getStats(this.track)}}};f.shimRemoveStream=function(a){a.RTCPeerConnection&&!("removeStream"in a.RTCPeerConnection.prototype)&&(a.RTCPeerConnection.prototype.removeStream=function(a){var b=this;l.deprecated("removeStream","removeTrack");this.getSenders().forEach(function(c){c.track&&a.getTracks().includes(c.track)&&b.removeTrack(c)})})};f.shimRTCDataChannel=function(a){a.DataChannel&&
!a.RTCDataChannel&&(a.RTCDataChannel=a.DataChannel)};f.shimAddTransceiver=function(b){if("object"===("undefined"===typeof b?"undefined":a(b))&&b.RTCPeerConnection){var c=b.RTCPeerConnection.prototype.addTransceiver;c&&(b.RTCPeerConnection.prototype.addTransceiver=function(){this.setParametersPromises=[];var a=arguments[1],b=a&&"sendEncodings"in a;b&&a.sendEncodings.forEach(function(a){if("rid"in a&&!/^[a-z0-9]{0,16}$/i.test(a.rid))throw new TypeError("Invalid RID value provided.");if("scaleResolutionDownBy"in
a&&!(1<=parseFloat(a.scaleResolutionDownBy)))throw new RangeError("scale_resolution_down_by must be >= 1.0");if("maxFramerate"in a&&!(0<=parseFloat(a.maxFramerate)))throw new RangeError("max_framerate must be >= 0.0");});var e=c.apply(this,arguments);if(b){var b=e.sender,d=b.getParameters();"encodings"in d||(d.encodings=a.sendEncodings,this.setParametersPromises.push(b.setParameters(d).catch(function(){})))}return e})}};f.shimCreateOffer=function(b){if("object"===("undefined"===typeof b?"undefined":
a(b))&&b.RTCPeerConnection){var c=b.RTCPeerConnection.prototype.createOffer;b.RTCPeerConnection.prototype.createOffer=function(){var a=this,b=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(function(){return c.apply(a,b)}).finally(function(){a.setParametersPromises=[]}):c.apply(this,arguments)}}};f.shimCreateAnswer=function(b){if("object"===("undefined"===typeof b?"undefined":a(b))&&b.RTCPeerConnection){var c=b.RTCPeerConnection.prototype.createAnswer;
b.RTCPeerConnection.prototype.createAnswer=function(){var a=this,b=arguments;return this.setParametersPromises&&this.setParametersPromises.length?Promise.all(this.setParametersPromises).then(function(){return c.apply(a,b)}).finally(function(){a.setParametersPromises=[]}):c.apply(this,arguments)}}};var l=function(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var c in a)Object.prototype.hasOwnProperty.call(a,c)&&(b[c]=a[c]);b.default=a;return b}(k("../utils"))},{"../utils":15,"./getdisplaymedia":12,
"./getusermedia":13}],12:[function(k,n,f){Object.defineProperty(f,"__esModule",{value:!0});f.shimGetDisplayMedia=function(d,a){!(d.navigator.mediaDevices&&"getDisplayMedia"in d.navigator.mediaDevices)&&d.navigator.mediaDevices&&(d.navigator.mediaDevices.getDisplayMedia=function(c){if(!c||!c.video)return c=new DOMException("getDisplayMedia without video constraints is undefined"),c.name="NotFoundError",c.code=8,Promise.reject(c);!0===c.video?c.video={mediaSource:a}:c.video.mediaSource=a;return d.navigator.mediaDevices.getUserMedia(c)})}},
{}],13:[function(k,n,f){Object.defineProperty(f,"__esModule",{value:!0});var d="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"===typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};f.shimGetUserMedia=function(c){var b=a.detectBrowser(c),l=c&&c.navigator;c=c&&c.MediaStreamTrack;l.getUserMedia=function(b,c,g){a.deprecated("navigator.getUserMedia","navigator.mediaDevices.getUserMedia");l.mediaDevices.getUserMedia(b).then(c,
g)};if(!(55<b.version&&"autoGainControl"in l.mediaDevices.getSupportedConstraints())){var e=function(a,b,c){b in a&&!(c in a)&&(a[c]=a[b],delete a[b])},h=l.mediaDevices.getUserMedia.bind(l.mediaDevices);l.mediaDevices.getUserMedia=function(a){if("object"===("undefined"===typeof a?"undefined":d(a))&&"object"===d(a.audio))a=JSON.parse(JSON.stringify(a)),e(a.audio,"autoGainControl","mozAutoGainControl"),e(a.audio,"noiseSuppression","mozNoiseSuppression");return h(a)};if(c&&c.prototype.getSettings){var g=
c.prototype.getSettings;c.prototype.getSettings=function(){var a=g.apply(this,arguments);e(a,"mozAutoGainControl","autoGainControl");e(a,"mozNoiseSuppression","noiseSuppression");return a}}if(c&&c.prototype.applyConstraints){var p=c.prototype.applyConstraints;c.prototype.applyConstraints=function(a){if("audio"===this.kind&&"object"===("undefined"===typeof a?"undefined":d(a)))a=JSON.parse(JSON.stringify(a)),e(a,"autoGainControl","mozAutoGainControl"),e(a,"noiseSuppression","mozNoiseSuppression");return p.apply(this,
[a])}}}};var a=function(a){if(a&&a.__esModule)return a;var b={};if(null!=a)for(var d in a)Object.prototype.hasOwnProperty.call(a,d)&&(b[d]=a[d]);b.default=a;return b}(k("../utils"))},{"../utils":15}],14:[function(k,n,f){function d(a){return a&&void 0!==a.video?Object.assign({},a,{video:c.compactObject(a.video)}):a}Object.defineProperty(f,"__esModule",{value:!0});var a="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"===typeof Symbol&&
a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};f.shimLocalStreamsAPI=function(b){if("object"===("undefined"===typeof b?"undefined":a(b))&&b.RTCPeerConnection){"getLocalStreams"in b.RTCPeerConnection.prototype||(b.RTCPeerConnection.prototype.getLocalStreams=function(){this._localStreams||(this._localStreams=[]);return this._localStreams});if(!("addStream"in b.RTCPeerConnection.prototype)){var c=b.RTCPeerConnection.prototype.addTrack;b.RTCPeerConnection.prototype.addStream=function(a){var b=
this;this._localStreams||(this._localStreams=[]);this._localStreams.includes(a)||this._localStreams.push(a);a.getAudioTracks().forEach(function(g){return c.call(b,g,a)});a.getVideoTracks().forEach(function(g){return c.call(b,g,a)})};b.RTCPeerConnection.prototype.addTrack=function(a){var b=arguments[1];b&&(this._localStreams?this._localStreams.includes(b)||this._localStreams.push(b):this._localStreams=[b]);return c.apply(this,arguments)}}"removeStream"in b.RTCPeerConnection.prototype||(b.RTCPeerConnection.prototype.removeStream=
function(a){var b=this;this._localStreams||(this._localStreams=[]);var c=this._localStreams.indexOf(a);if(-1!==c){this._localStreams.splice(c,1);var d=a.getTracks();this.getSenders().forEach(function(a){d.includes(a.track)&&b.removeTrack(a)})}})}};f.shimRemoteStreamsAPI=function(b){if("object"===("undefined"===typeof b?"undefined":a(b))&&b.RTCPeerConnection)if("getRemoteStreams"in b.RTCPeerConnection.prototype||(b.RTCPeerConnection.prototype.getRemoteStreams=function(){return this._remoteStreams?
this._remoteStreams:[]}),!("onaddstream"in b.RTCPeerConnection.prototype)){Object.defineProperty(b.RTCPeerConnection.prototype,"onaddstream",{get:function(){return this._onaddstream},set:function(a){var b=this;this._onaddstream&&(this.removeEventListener("addstream",this._onaddstream),this.removeEventListener("track",this._onaddstreampoly));this.addEventListener("addstream",this._onaddstream=a);this.addEventListener("track",this._onaddstreampoly=function(a){a.streams.forEach(function(a){b._remoteStreams||
(b._remoteStreams=[]);if(!b._remoteStreams.includes(a)){b._remoteStreams.push(a);var c=new Event("addstream");c.stream=a;b.dispatchEvent(c)}})})}});var c=b.RTCPeerConnection.prototype.setRemoteDescription;b.RTCPeerConnection.prototype.setRemoteDescription=function(){var a=this;this._onaddstreampoly||this.addEventListener("track",this._onaddstreampoly=function(b){b.streams.forEach(function(b){a._remoteStreams||(a._remoteStreams=[]);if(!(0<=a._remoteStreams.indexOf(b))){a._remoteStreams.push(b);var c=
new Event("addstream");c.stream=b;a.dispatchEvent(c)}})});return c.apply(a,arguments)}}};f.shimCallbacksAPI=function(b){if("object"===("undefined"===typeof b?"undefined":a(b))&&b.RTCPeerConnection){b=b.RTCPeerConnection.prototype;var c=b.createOffer,d=b.createAnswer,h=b.setLocalDescription,g=b.setRemoteDescription,p=b.addIceCandidate;b.createOffer=function(a,b){var g=c.apply(this,[2<=arguments.length?arguments[2]:arguments[0]]);if(!b)return g;g.then(a,b);return Promise.resolve()};b.createAnswer=function(a,
b){var c=d.apply(this,[2<=arguments.length?arguments[2]:arguments[0]]);if(!b)return c;c.then(a,b);return Promise.resolve()};var f=function(a,b,c){a=h.apply(this,[a]);if(!c)return a;a.then(b,c);return Promise.resolve()};b.setLocalDescription=f;f=function(a,b,c){a=g.apply(this,[a]);if(!c)return a;a.then(b,c);return Promise.resolve()};b.setRemoteDescription=f;f=function(a,b,c){a=p.apply(this,[a]);if(!c)return a;a.then(b,c);return Promise.resolve()};b.addIceCandidate=f}};f.shimGetUserMedia=function(a){var c=
a&&a.navigator;if(c.mediaDevices&&c.mediaDevices.getUserMedia){a=c.mediaDevices;var e=a.getUserMedia.bind(a);c.mediaDevices.getUserMedia=function(a){return e(d(a))}}!c.getUserMedia&&(c.mediaDevices&&c.mediaDevices.getUserMedia)&&(c.getUserMedia=function(a,b,d){c.mediaDevices.getUserMedia(a).then(b,d)}.bind(c))};f.shimConstraints=d;f.shimRTCIceServerUrls=function(a){var d=a.RTCPeerConnection;a.RTCPeerConnection=function(a,b){if(a&&a.iceServers){for(var g=[],p=0;p<a.iceServers.length;p++){var f=a.iceServers[p];
!f.hasOwnProperty("urls")&&f.hasOwnProperty("url")?(c.deprecated("RTCIceServer.url","RTCIceServer.urls"),f=JSON.parse(JSON.stringify(f)),f.urls=f.url,delete f.url,g.push(f)):g.push(a.iceServers[p])}a.iceServers=g}return new d(a,b)};a.RTCPeerConnection.prototype=d.prototype;"generateCertificate"in a.RTCPeerConnection&&Object.defineProperty(a.RTCPeerConnection,"generateCertificate",{get:function(){return d.generateCertificate}})};f.shimTrackEventTransceiver=function(b){"object"===("undefined"===typeof b?
"undefined":a(b))&&(b.RTCTrackEvent&&"receiver"in b.RTCTrackEvent.prototype&&!("transceiver"in b.RTCTrackEvent.prototype))&&Object.defineProperty(b.RTCTrackEvent.prototype,"transceiver",{get:function(){return{receiver:this.receiver}}})};f.shimCreateOfferLegacy=function(a){var c=a.RTCPeerConnection.prototype.createOffer;a.RTCPeerConnection.prototype.createOffer=function(a){if(a){"undefined"!==typeof a.offerToReceiveAudio&&(a.offerToReceiveAudio=!!a.offerToReceiveAudio);var b=this.getTransceivers().find(function(a){return"audio"===
a.receiver.track.kind});!1===a.offerToReceiveAudio&&b?"sendrecv"===b.direction?b.setDirection?b.setDirection("sendonly"):b.direction="sendonly":"recvonly"===b.direction&&(b.setDirection?b.setDirection("inactive"):b.direction="inactive"):!0===a.offerToReceiveAudio&&!b&&this.addTransceiver("audio");"undefined"!==typeof a.offerToReceiveVideo&&(a.offerToReceiveVideo=!!a.offerToReceiveVideo);b=this.getTransceivers().find(function(a){return"video"===a.receiver.track.kind});!1===a.offerToReceiveVideo&&b?
"sendrecv"===b.direction?b.setDirection?b.setDirection("sendonly"):b.direction="sendonly":"recvonly"===b.direction&&(b.setDirection?b.setDirection("inactive"):b.direction="inactive"):!0===a.offerToReceiveVideo&&!b&&this.addTransceiver("video")}return c.apply(this,arguments)}};var c=function(a){if(a&&a.__esModule)return a;var c={};if(null!=a)for(var d in a)Object.prototype.hasOwnProperty.call(a,d)&&(c[d]=a[d]);c.default=a;return c}(k("../utils"))},{"../utils":15}],15:[function(k,n,f){function d(a,
b,c){b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c;return a}function a(a,b,c){return(a=a.match(b))&&a.length>=c&&parseInt(a[c],10)}function c(a){return"[object Object]"!==Object.prototype.toString.call(a)?a:Object.keys(a).reduce(function(b,e){var f="[object Object]"===Object.prototype.toString.call(a[e]),h=f?c(a[e]):a[e],f=f&&!Object.keys(h).length;return void 0===h||f?b:Object.assign(b,d({},e,h))},{})}function b(a,c,d){c&&!d.has(c.id)&&(d.set(c.id,c),
Object.keys(c).forEach(function(e){e.endsWith("Id")?b(a,a.get(c[e]),d):e.endsWith("Ids")&&c[e].forEach(function(c){b(a,a.get(c),d)})}))}Object.defineProperty(f,"__esModule",{value:!0});var l="function"===typeof Symbol&&"symbol"===typeof Symbol.iterator?function(a){return typeof a}:function(a){return a&&"function"===typeof Symbol&&a.constructor===Symbol&&a!==Symbol.prototype?"symbol":typeof a};f.extractVersion=a;f.wrapPeerConnectionEvent=function(a,b,c){if(a.RTCPeerConnection){a=a.RTCPeerConnection.prototype;
var d=a.addEventListener;a.addEventListener=function(a,g){if(a!==b)return d.apply(this,arguments);var u=function(a){(a=c(a))&&g(a)};this._eventMap=this._eventMap||{};this._eventMap[g]=u;return d.apply(this,[a,u])};var e=a.removeEventListener;a.removeEventListener=function(a,c){if(a!==b||!this._eventMap||!this._eventMap[c])return e.apply(this,arguments);var d=this._eventMap[c];delete this._eventMap[c];return e.apply(this,[a,d])};Object.defineProperty(a,"on"+b,{get:function(){return this["_on"+b]},
set:function(a){this["_on"+b]&&(this.removeEventListener(b,this["_on"+b]),delete this["_on"+b]);a&&this.addEventListener(b,this["_on"+b]=a)},enumerable:!0,configurable:!0})}};f.disableLog=function(a){return"boolean"!==typeof a?Error("Argument type: "+("undefined"===typeof a?"undefined":l(a))+". Please use a boolean."):(e=a)?"adapter.js logging disabled":"adapter.js logging enabled"};f.disableWarnings=function(a){if("boolean"!==typeof a)return Error("Argument type: "+("undefined"===typeof a?"undefined":
l(a))+". Please use a boolean.");h=!a;return"adapter.js deprecation warnings "+(a?"disabled":"enabled")};f.log=function(){"object"===("undefined"===typeof window?"undefined":l(window))&&!e&&"undefined"!==typeof console&&"function"===typeof console.log&&console.log.apply(console,arguments)};f.deprecated=function(a,b){h&&console.warn(a+" is deprecated, please use "+b+" instead.")};f.detectBrowser=function(b){var c=b.navigator,d={browser:null,version:null};if("undefined"===typeof b||!b.navigator)return d.browser=
"Not a browser.",d;c.mozGetUserMedia?(d.browser="firefox",d.version=a(c.userAgent,/Firefox\/(\d+)\./,1)):c.webkitGetUserMedia||!1===b.isSecureContext&&b.webkitRTCPeerConnection&&!b.RTCIceGatherer?(d.browser="chrome",d.version=a(c.userAgent,/Chrom(e|ium)\/(\d+)\./,2)):c.mediaDevices&&c.userAgent.match(/Edge\/(\d+).(\d+)$/)?(d.browser="edge",d.version=a(c.userAgent,/Edge\/(\d+).(\d+)$/,2)):b.RTCPeerConnection&&c.userAgent.match(/AppleWebKit\/(\d+)\./)?(d.browser="safari",d.version=a(c.userAgent,/AppleWebKit\/(\d+)\./,
1),d.supportsUnifiedPlan=b.RTCRtpTransceiver&&"currentDirection"in b.RTCRtpTransceiver.prototype):d.browser="Not a supported browser.";return d};f.compactObject=c;f.walkStats=b;f.filterStats=function(a,c,d){var e=d?"outbound-rtp":"inbound-rtp",f=new Map;if(null===c)return f;var h=[];a.forEach(function(a){"track"===a.type&&a.trackIdentifier===c.id&&h.push(a)});h.forEach(function(c){a.forEach(function(d){d.type===e&&d.trackId===c.id&&b(a,d,f)})});return f};var e=!0,h=!0},{}],16:[function(k,n,f){function d(a,
b,c,d,e){b=h.writeRtpDescription(a.kind,b);b+=h.writeIceParameters(a.iceGatherer.getLocalParameters());b+=h.writeDtlsParameters(a.dtlsTransport.getLocalParameters(),"offer"===c?"actpass":e||"active");b+="a=mid:"+a.mid+"\r\n";b=a.rtpSender&&a.rtpReceiver?b+"a=sendrecv\r\n":a.rtpSender?b+"a=sendonly\r\n":a.rtpReceiver?b+"a=recvonly\r\n":b+"a=inactive\r\n";a.rtpSender&&(c=a.rtpSender._initialTrackId||a.rtpSender.track.id,a.rtpSender._initialTrackId=c,d="msid:"+(d?d.id:"-")+" "+c+"\r\n",b=b+("a="+d)+
("a=ssrc:"+a.sendEncodingParameters[0].ssrc+" "+d),a.sendEncodingParameters[0].rtx&&(b+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" "+d,b+="a=ssrc-group:FID "+a.sendEncodingParameters[0].ssrc+" "+a.sendEncodingParameters[0].rtx.ssrc+"\r\n"));b+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" cname:"+h.localCName+"\r\n";a.rtpSender&&a.sendEncodingParameters[0].rtx&&(b+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" cname:"+h.localCName+"\r\n");return b}function a(a,b){var c=!1;a=JSON.parse(JSON.stringify(a));
return a.filter(function(a){if(a&&(a.urls||a.url)){var d=a.urls||a.url;a.url&&!a.urls&&console.warn("RTCIceServer.url is deprecated! Use urls instead.");var e="string"===typeof d;e&&(d=[d]);d=d.filter(function(a){return 0===a.indexOf("turn:")&&-1!==a.indexOf("transport=udp")&&-1===a.indexOf("turn:[")&&!c?c=!0:0===a.indexOf("stun:")&&14393<=b&&-1===a.indexOf("?transport=udp")});delete a.url;a.urls=e?d[0]:d;return!!d.length}})}function c(a,b){var c={codecs:[],headerExtensions:[],fecMechanisms:[]},d=
function(a,b){a=parseInt(a,10);for(var c=0;c<b.length;c++)if(b[c].payloadType===a||b[c].preferredPayloadType===a)return b[c]},e=function(a,b,c,e){a=d(a.parameters.apt,c);b=d(b.parameters.apt,e);return a&&b&&a.name.toLowerCase()===b.name.toLowerCase()};a.codecs.forEach(function(d){for(var f=0;f<b.codecs.length;f++){var u=b.codecs[f];if(d.name.toLowerCase()===u.name.toLowerCase()&&d.clockRate===u.clockRate&&(!("rtx"===d.name.toLowerCase()&&d.parameters&&u.parameters.apt)||e(d,u,a.codecs,b.codecs))){u=
JSON.parse(JSON.stringify(u));u.numChannels=Math.min(d.numChannels,u.numChannels);c.codecs.push(u);u.rtcpFeedback=u.rtcpFeedback.filter(function(a){for(var b=0;b<d.rtcpFeedback.length;b++)if(d.rtcpFeedback[b].type===a.type&&d.rtcpFeedback[b].parameter===a.parameter)return!0;return!1});break}}});a.headerExtensions.forEach(function(a){for(var d=0;d<b.headerExtensions.length;d++){var u=b.headerExtensions[d];if(a.uri===u.uri){c.headerExtensions.push(u);break}}});return c}function b(a,b,c){return-1!==
{offer:{setLocalDescription:["stable","have-local-offer"],setRemoteDescription:["stable","have-remote-offer"]},answer:{setLocalDescription:["have-remote-offer","have-local-pranswer"],setRemoteDescription:["have-local-offer","have-remote-pranswer"]}}[b][a].indexOf(c)}function l(a,b){var c=a.getRemoteCandidates().find(function(a){return b.foundation===a.foundation&&b.ip===a.ip&&b.port===a.port&&b.priority===a.priority&&b.protocol===a.protocol&&b.type===a.type});c||a.addRemoteCandidate(b);return!c}function e(a,
b){var c=Error(b);c.name=a;c.code={NotSupportedError:9,InvalidStateError:11,InvalidAccessError:15,TypeError:void 0,OperationError:void 0}[a];return c}var h=k("sdp");n.exports=function(g,f){function k(a,b){b.addTrack(a);b.dispatchEvent(new g.MediaStreamTrackEvent("addtrack",{track:a}))}function n(a,b){b.removeTrack(a);b.dispatchEvent(new g.MediaStreamTrackEvent("removetrack",{track:a}))}function q(a,b,c,d){var e=new Event("track");e.track=b;e.receiver=c;e.transceiver={receiver:c};e.streams=d;g.setTimeout(function(){a._dispatchEvent("track",
e)})}var m=function(b){var c=this,d=document.createDocumentFragment();["addEventListener","removeEventListener","dispatchEvent"].forEach(function(a){c[a]=d[a].bind(d)});this.canTrickleIceCandidates=null;this.needNegotiation=!1;this.localStreams=[];this.remoteStreams=[];this._remoteDescription=this._localDescription=null;this.signalingState="stable";this.iceGatheringState=this.connectionState=this.iceConnectionState="new";b=JSON.parse(JSON.stringify(b||{}));this.usingBundle="max-bundle"===b.bundlePolicy;
if("negotiate"===b.rtcpMuxPolicy)throw e("NotSupportedError","rtcpMuxPolicy 'negotiate' is not supported");b.rtcpMuxPolicy||(b.rtcpMuxPolicy="require");switch(b.iceTransportPolicy){case "all":case "relay":break;default:b.iceTransportPolicy="all"}switch(b.bundlePolicy){case "balanced":case "max-compat":case "max-bundle":break;default:b.bundlePolicy="balanced"}b.iceServers=a(b.iceServers||[],f);this._iceGatherers=[];if(b.iceCandidatePoolSize)for(var l=b.iceCandidatePoolSize;0<l;l--)this._iceGatherers.push(new g.RTCIceGatherer({iceServers:b.iceServers,
gatherPolicy:b.iceTransportPolicy}));else b.iceCandidatePoolSize=0;this._config=b;this.transceivers=[];this._sdpSessionId=h.generateSessionId();this._sdpSessionVersion=0;this._dtlsRole=void 0;this._isClosed=!1};Object.defineProperty(m.prototype,"localDescription",{configurable:!0,get:function(){return this._localDescription}});Object.defineProperty(m.prototype,"remoteDescription",{configurable:!0,get:function(){return this._remoteDescription}});m.prototype.onicecandidate=null;m.prototype.onaddstream=
null;m.prototype.ontrack=null;m.prototype.onremovestream=null;m.prototype.onsignalingstatechange=null;m.prototype.oniceconnectionstatechange=null;m.prototype.onconnectionstatechange=null;m.prototype.onicegatheringstatechange=null;m.prototype.onnegotiationneeded=null;m.prototype.ondatachannel=null;m.prototype._dispatchEvent=function(a,b){if(!this._isClosed&&(this.dispatchEvent(b),"function"===typeof this["on"+a]))this["on"+a](b)};m.prototype._emitGatheringStateChange=function(){var a=new Event("icegatheringstatechange");
this._dispatchEvent("icegatheringstatechange",a)};m.prototype.getConfiguration=function(){return this._config};m.prototype.getLocalStreams=function(){return this.localStreams};m.prototype.getRemoteStreams=function(){return this.remoteStreams};m.prototype._createTransceiver=function(a,b){var c=0<this.transceivers.length,d={track:null,iceGatherer:null,iceTransport:null,dtlsTransport:null,localCapabilities:null,remoteCapabilities:null,rtpSender:null,rtpReceiver:null,kind:a,mid:null,sendEncodingParameters:null,
recvEncodingParameters:null,stream:null,associatedRemoteMediaStreams:[],wantReceive:!0};this.usingBundle&&c?(d.iceTransport=this.transceivers[0].iceTransport,d.dtlsTransport=this.transceivers[0].dtlsTransport):(c=this._createIceAndDtlsTransports(),d.iceTransport=c.iceTransport,d.dtlsTransport=c.dtlsTransport);b||this.transceivers.push(d);return d};m.prototype.addTrack=function(a,b){if(this._isClosed)throw e("InvalidStateError","Attempted to call addTrack on a closed peerconnection.");if(this.transceivers.find(function(b){return b.track===
a}))throw e("InvalidAccessError","Track already exists.");for(var c,d=0;d<this.transceivers.length;d++)!this.transceivers[d].track&&this.transceivers[d].kind===a.kind&&(c=this.transceivers[d]);c||(c=this._createTransceiver(a.kind));this._maybeFireNegotiationNeeded();-1===this.localStreams.indexOf(b)&&this.localStreams.push(b);c.track=a;c.stream=b;c.rtpSender=new g.RTCRtpSender(a,c.dtlsTransport);return c.rtpSender};m.prototype.addStream=function(a){var b=this;if(15025<=f)a.getTracks().forEach(function(c){b.addTrack(c,
a)});else{var c=a.clone();a.getTracks().forEach(function(a,b){var d=c.getTracks()[b];a.addEventListener("enabled",function(a){d.enabled=a.enabled})});c.getTracks().forEach(function(a){b.addTrack(a,c)})}};m.prototype.removeTrack=function(a){if(this._isClosed)throw e("InvalidStateError","Attempted to call removeTrack on a closed peerconnection.");if(!(a instanceof g.RTCRtpSender))throw new TypeError("Argument 1 of RTCPeerConnection.removeTrack does not implement interface RTCRtpSender.");var b=this.transceivers.find(function(b){return b.rtpSender===
a});if(!b)throw e("InvalidAccessError","Sender was not created by this connection.");var c=b.stream;b.rtpSender.stop();b.rtpSender=null;b.track=null;b.stream=null;-1===this.transceivers.map(function(a){return a.stream}).indexOf(c)&&-1<this.localStreams.indexOf(c)&&this.localStreams.splice(this.localStreams.indexOf(c),1);this._maybeFireNegotiationNeeded()};m.prototype.removeStream=function(a){var b=this;a.getTracks().forEach(function(a){var c=b.getSenders().find(function(b){return b.track===a});c&&
b.removeTrack(c)})};m.prototype.getSenders=function(){return this.transceivers.filter(function(a){return!!a.rtpSender}).map(function(a){return a.rtpSender})};m.prototype.getReceivers=function(){return this.transceivers.filter(function(a){return!!a.rtpReceiver}).map(function(a){return a.rtpReceiver})};m.prototype._createIceGatherer=function(a,b){var c=this;if(b&&0<a)return this.transceivers[0].iceGatherer;if(this._iceGatherers.length)return this._iceGatherers.shift();var d=new g.RTCIceGatherer({iceServers:this._config.iceServers,
gatherPolicy:this._config.iceTransportPolicy});Object.defineProperty(d,"state",{value:"new",writable:!0});this.transceivers[a].bufferedCandidateEvents=[];this.transceivers[a].bufferCandidates=function(b){var e=!b.candidate||0===Object.keys(b.candidate).length;d.state=e?"completed":"gathering";null!==c.transceivers[a].bufferedCandidateEvents&&c.transceivers[a].bufferedCandidateEvents.push(b)};d.addEventListener("localcandidate",this.transceivers[a].bufferCandidates);return d};m.prototype._gather=function(a,
b){var c=this,d=this.transceivers[b].iceGatherer;if(!d.onlocalcandidate){var e=this.transceivers[b].bufferedCandidateEvents;this.transceivers[b].bufferedCandidateEvents=null;d.removeEventListener("localcandidate",this.transceivers[b].bufferCandidates);d.onlocalcandidate=function(e){if(!(c.usingBundle&&0<b)){var g=new Event("icecandidate");g.candidate={sdpMid:a,sdpMLineIndex:b};var f=e.candidate;if(e=!f||0===Object.keys(f).length){if("new"===d.state||"gathering"===d.state)d.state="completed"}else"new"===
d.state&&(d.state="gathering"),f.component=1,f.ufrag=d.getLocalParameters().usernameFragment,f=h.writeCandidate(f),g.candidate=Object.assign(g.candidate,h.parseCandidate(f)),g.candidate.candidate=f,g.candidate.toJSON=function(){return{candidate:g.candidate.candidate,sdpMid:g.candidate.sdpMid,sdpMLineIndex:g.candidate.sdpMLineIndex,usernameFragment:g.candidate.usernameFragment}};f=h.getMediaSections(c._localDescription.sdp);f[g.candidate.sdpMLineIndex]=e?f[g.candidate.sdpMLineIndex]+"a=end-of-candidates\r\n":
f[g.candidate.sdpMLineIndex]+("a="+g.candidate.candidate+"\r\n");c._localDescription.sdp=h.getDescription(c._localDescription.sdp)+f.join("");f=c.transceivers.every(function(a){return a.iceGatherer&&"completed"===a.iceGatherer.state});"gathering"!==c.iceGatheringState&&(c.iceGatheringState="gathering",c._emitGatheringStateChange());e||c._dispatchEvent("icecandidate",g);f&&(c._dispatchEvent("icecandidate",new Event("icecandidate")),c.iceGatheringState="complete",c._emitGatheringStateChange())}};g.setTimeout(function(){e.forEach(function(a){d.onlocalcandidate(a)})},
0)}};m.prototype._createIceAndDtlsTransports=function(){var a=this,b=new g.RTCIceTransport(null);b.onicestatechange=function(){a._updateIceConnectionState();a._updateConnectionState()};var c=new g.RTCDtlsTransport(b);c.ondtlsstatechange=function(){a._updateConnectionState()};c.onerror=function(){Object.defineProperty(c,"state",{value:"failed",writable:!0});a._updateConnectionState()};return{iceTransport:b,dtlsTransport:c}};m.prototype._disposeIceAndDtlsTransports=function(a){var b=this.transceivers[a].iceGatherer;
b&&(delete b.onlocalcandidate,delete this.transceivers[a].iceGatherer);if(b=this.transceivers[a].iceTransport)delete b.onicestatechange,delete this.transceivers[a].iceTransport;if(b=this.transceivers[a].dtlsTransport)delete b.ondtlsstatechange,delete b.onerror,delete this.transceivers[a].dtlsTransport};m.prototype._transceive=function(a,b,d){var e=c(a.localCapabilities,a.remoteCapabilities);b&&a.rtpSender&&(e.encodings=a.sendEncodingParameters,e.rtcp={cname:h.localCName,compound:a.rtcpParameters.compound},
a.recvEncodingParameters.length&&(e.rtcp.ssrc=a.recvEncodingParameters[0].ssrc),a.rtpSender.send(e));d&&(a.rtpReceiver&&0<e.codecs.length)&&("video"===a.kind&&(a.recvEncodingParameters&&15019>f)&&a.recvEncodingParameters.forEach(function(a){delete a.rtx}),e.encodings=a.recvEncodingParameters.length?a.recvEncodingParameters:[{}],e.rtcp={compound:a.rtcpParameters.compound},a.rtcpParameters.cname&&(e.rtcp.cname=a.rtcpParameters.cname),a.sendEncodingParameters.length&&(e.rtcp.ssrc=a.sendEncodingParameters[0].ssrc),
a.rtpReceiver.receive(e))};m.prototype.setLocalDescription=function(a){var d=this;if(-1===["offer","answer"].indexOf(a.type))return Promise.reject(e("TypeError",'Unsupported type "'+a.type+'"'));if(!b("setLocalDescription",a.type,d.signalingState)||d._isClosed)return Promise.reject(e("InvalidStateError","Can not set local "+a.type+" in state "+d.signalingState));var g,f;if("offer"===a.type)g=h.splitSections(a.sdp),f=g.shift(),g.forEach(function(a,b){var c=h.parseRtpParameters(a);d.transceivers[b].localCapabilities=
c}),d.transceivers.forEach(function(a,b){d._gather(a.mid,b)});else if("answer"===a.type){g=h.splitSections(d._remoteDescription.sdp);f=g.shift();var l=0<h.matchPrefix(f,"a=ice-lite").length;g.forEach(function(a,b){var e=d.transceivers[b],g=e.iceGatherer,u=e.iceTransport,k=e.dtlsTransport,x=e.localCapabilities,p=e.remoteCapabilities;if(!(h.isRejected(a)&&0===h.matchPrefix(a,"a=bundle-only").length)&&!e.rejected){var m=h.getIceParameters(a,f),n=h.getDtlsParameters(a,f);l&&(n.role="server");if(!d.usingBundle||
0===b)d._gather(e.mid,b),"new"===u.state&&u.start(g,m,l?"controlling":"controlled"),"new"===k.state&&k.start(n);g=c(x,p);d._transceive(e,0<g.codecs.length,!1)}})}d._localDescription={type:a.type,sdp:a.sdp};"offer"===a.type?d._updateSignalingState("have-local-offer"):d._updateSignalingState("stable");return Promise.resolve()};m.prototype.setRemoteDescription=function(a){var d=this;if(-1===["offer","answer"].indexOf(a.type))return Promise.reject(e("TypeError",'Unsupported type "'+a.type+'"'));if(!b("setRemoteDescription",
a.type,d.signalingState)||d._isClosed)return Promise.reject(e("InvalidStateError","Can not set remote "+a.type+" in state "+d.signalingState));var x={};d.remoteStreams.forEach(function(a){x[a.id]=a});var m=[],w=h.splitSections(a.sdp),F=w.shift(),D=0<h.matchPrefix(F,"a=ice-lite").length,r=0<h.matchPrefix(F,"a=group:BUNDLE ").length;d.usingBundle=r;var t=h.matchPrefix(F,"a=ice-options:")[0];d.canTrickleIceCandidates=t?0<=t.substr(14).split(" ").indexOf("trickle"):!1;w.forEach(function(b,e){var w=h.splitLines(b),
q=h.getKind(b),t=h.isRejected(b)&&0===h.matchPrefix(b,"a=bundle-only").length,H=w[0].substr(2).split(" ")[2],w=h.getDirection(b,F),B=h.parseMsid(b),I=h.getMid(b)||h.generateIdentifier();if(t||"application"===q&&("DTLS/SCTP"===H||"UDP/DTLS/SCTP"===H))d.transceivers[e]={mid:I,kind:q,protocol:H,rejected:!0};else{!t&&(d.transceivers[e]&&d.transceivers[e].rejected)&&(d.transceivers[e]=d._createTransceiver(q,!0));var s,G,E,z,R=h.parseRtpParameters(b),J,v;t||(J=h.getIceParameters(b,F),v=h.getDtlsParameters(b,
F),v.role="client");var H=h.parseRtpEncodingParameters(b),y=h.parseRtcpParameters(b),S=0<h.matchPrefix(b,"a=end-of-candidates",F).length,K=h.matchPrefix(b,"a=candidate:").map(function(a){return h.parseCandidate(a)}).filter(function(a){return 1===a.component});if(("offer"===a.type||"answer"===a.type)&&!t&&r&&0<e&&d.transceivers[e])d._disposeIceAndDtlsTransports(e),d.transceivers[e].iceGatherer=d.transceivers[0].iceGatherer,d.transceivers[e].iceTransport=d.transceivers[0].iceTransport,d.transceivers[e].dtlsTransport=
d.transceivers[0].dtlsTransport,d.transceivers[e].rtpSender&&d.transceivers[e].rtpSender.setTransport(d.transceivers[0].dtlsTransport),d.transceivers[e].rtpReceiver&&d.transceivers[e].rtpReceiver.setTransport(d.transceivers[0].dtlsTransport);if("offer"===a.type&&!t)s=d.transceivers[e]||d._createTransceiver(q),s.mid=I,s.iceGatherer||(s.iceGatherer=d._createIceGatherer(e,r)),K.length&&"new"===s.iceTransport.state&&(S&&(!r||0===e)?s.iceTransport.setRemoteCandidates(K):K.forEach(function(a){l(s.iceTransport,
a)})),I=g.RTCRtpReceiver.getCapabilities(q),15019>f&&(I.codecs=I.codecs.filter(function(a){return"rtx"!==a.name})),t=s.sendEncodingParameters||[{ssrc:1001*(2*e+2)}],J=!1,"sendrecv"===w||"sendonly"===w?(J=!s.rtpReceiver,z=s.rtpReceiver||new g.RTCRtpReceiver(s.dtlsTransport,q),J&&(w=z.track,B&&"-"===B.stream||(B?(x[B.stream]||(x[B.stream]=new g.MediaStream,Object.defineProperty(x[B.stream],"id",{get:function(){return B.stream}})),Object.defineProperty(w,"id",{get:function(){return B.track}}),G=x[B.stream]):
(x.default||(x.default=new g.MediaStream),G=x.default)),G&&(k(w,G),s.associatedRemoteMediaStreams.push(G)),m.push([w,z,G]))):s.rtpReceiver&&s.rtpReceiver.track&&(s.associatedRemoteMediaStreams.forEach(function(a){var b=a.getTracks().find(function(a){return a.id===s.rtpReceiver.track.id});b&&n(b,a)}),s.associatedRemoteMediaStreams=[]),s.localCapabilities=I,s.remoteCapabilities=R,s.rtpReceiver=z,s.rtcpParameters=y,s.sendEncodingParameters=t,s.recvEncodingParameters=H,d._transceive(d.transceivers[e],
!1,J);else if("answer"===a.type&&!t){s=d.transceivers[e];G=s.iceGatherer;q=s.iceTransport;E=s.dtlsTransport;z=s.rtpReceiver;t=s.sendEncodingParameters;I=s.localCapabilities;d.transceivers[e].recvEncodingParameters=H;d.transceivers[e].remoteCapabilities=R;d.transceivers[e].rtcpParameters=y;K.length&&"new"===q.state&&((D||S)&&(!r||0===e)?q.setRemoteCandidates(K):K.forEach(function(a){l(s.iceTransport,a)}));if(!r||0===e)"new"===q.state&&q.start(G,J,"controlling"),"new"===E.state&&E.start(v);!c(s.localCapabilities,
s.remoteCapabilities).codecs.filter(function(a){return"rtx"===a.name.toLowerCase()}).length&&s.sendEncodingParameters[0].rtx&&delete s.sendEncodingParameters[0].rtx;d._transceive(s,"sendrecv"===w||"recvonly"===w,"sendrecv"===w||"sendonly"===w);z&&("sendrecv"===w||"sendonly"===w)?(w=z.track,B?(x[B.stream]||(x[B.stream]=new g.MediaStream),k(w,x[B.stream]),m.push([w,z,x[B.stream]])):(x.default||(x.default=new g.MediaStream),k(w,x.default),m.push([w,z,x.default]))):delete s.rtpReceiver}}});void 0===d._dtlsRole&&
(d._dtlsRole="offer"===a.type?"active":"passive");d._remoteDescription={type:a.type,sdp:a.sdp};"offer"===a.type?d._updateSignalingState("have-remote-offer"):d._updateSignalingState("stable");Object.keys(x).forEach(function(a){var b=x[a];if(b.getTracks().length){if(-1===d.remoteStreams.indexOf(b)){d.remoteStreams.push(b);var c=new Event("addstream");c.stream=b;g.setTimeout(function(){d._dispatchEvent("addstream",c)})}m.forEach(function(a){var c=a[0],e=a[1];b.id===a[2].id&&q(d,c,e,[b])})}});m.forEach(function(a){a[2]||
q(d,a[0],a[1],[])});g.setTimeout(function(){d&&d.transceivers&&d.transceivers.forEach(function(a){a.iceTransport&&("new"===a.iceTransport.state&&0<a.iceTransport.getRemoteCandidates().length)&&(console.warn("Timeout for addRemoteCandidate. Consider sending an end-of-candidates notification"),a.iceTransport.addRemoteCandidate({}))})},4E3);return Promise.resolve()};m.prototype.close=function(){this.transceivers.forEach(function(a){a.iceTransport&&a.iceTransport.stop();a.dtlsTransport&&a.dtlsTransport.stop();
a.rtpSender&&a.rtpSender.stop();a.rtpReceiver&&a.rtpReceiver.stop()});this._isClosed=!0;this._updateSignalingState("closed")};m.prototype._updateSignalingState=function(a){this.signalingState=a;a=new Event("signalingstatechange");this._dispatchEvent("signalingstatechange",a)};m.prototype._maybeFireNegotiationNeeded=function(){var a=this;"stable"!==this.signalingState||!0===this.needNegotiation||(this.needNegotiation=!0,g.setTimeout(function(){if(a.needNegotiation){a.needNegotiation=!1;var b=new Event("negotiationneeded");
a._dispatchEvent("negotiationneeded",b)}},0))};m.prototype._updateIceConnectionState=function(){var a,b={"new":0,closed:0,checking:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(a){a.iceTransport&&!a.rejected&&b[a.iceTransport.state]++});a="new";0<b.failed?a="failed":0<b.checking?a="checking":0<b.disconnected?a="disconnected":0<b.new?a="new":0<b.connected?a="connected":0<b.completed&&(a="completed");a!==this.iceConnectionState&&(this.iceConnectionState=a,a=new Event("iceconnectionstatechange"),
this._dispatchEvent("iceconnectionstatechange",a))};m.prototype._updateConnectionState=function(){var a,b={"new":0,closed:0,connecting:0,connected:0,completed:0,disconnected:0,failed:0};this.transceivers.forEach(function(a){a.iceTransport&&(a.dtlsTransport&&!a.rejected)&&(b[a.iceTransport.state]++,b[a.dtlsTransport.state]++)});b.connected+=b.completed;a="new";0<b.failed?a="failed":0<b.connecting?a="connecting":0<b.disconnected?a="disconnected":0<b.new?a="new":0<b.connected&&(a="connected");a!==this.connectionState&&
(this.connectionState=a,a=new Event("connectionstatechange"),this._dispatchEvent("connectionstatechange",a))};m.prototype.createOffer=function(a){var b=this;if(b._isClosed)return Promise.reject(e("InvalidStateError","Can not call createOffer after close"));var c=b.transceivers.filter(function(a){return"audio"===a.kind}).length,l=b.transceivers.filter(function(a){return"video"===a.kind}).length;if(a){if(a.mandatory||a.optional)throw new TypeError("Legacy mandatory/optional constraints not supported.");
void 0!==a.offerToReceiveAudio&&(c=!0===a.offerToReceiveAudio?1:!1===a.offerToReceiveAudio?0:a.offerToReceiveAudio);void 0!==a.offerToReceiveVideo&&(l=!0===a.offerToReceiveVideo?1:!1===a.offerToReceiveVideo?0:a.offerToReceiveVideo)}for(b.transceivers.forEach(function(a){"audio"===a.kind?(c--,0>c&&(a.wantReceive=!1)):"video"===a.kind&&(l--,0>l&&(a.wantReceive=!1))});0<c||0<l;)0<c&&(b._createTransceiver("audio"),c--),0<l&&(b._createTransceiver("video"),l--);var k=h.writeSessionBoilerplate(b._sdpSessionId,
b._sdpSessionVersion++);b.transceivers.forEach(function(a,c){var d=a.track,e=a.kind,l=a.mid||h.generateIdentifier();a.mid=l;a.iceGatherer||(a.iceGatherer=b._createIceGatherer(c,b.usingBundle));l=g.RTCRtpSender.getCapabilities(e);15019>f&&(l.codecs=l.codecs.filter(function(a){return"rtx"!==a.name}));l.codecs.forEach(function(b){"H264"===b.name&&void 0===b.parameters["level-asymmetry-allowed"]&&(b.parameters["level-asymmetry-allowed"]="1");a.remoteCapabilities&&a.remoteCapabilities.codecs&&a.remoteCapabilities.codecs.forEach(function(a){b.name.toLowerCase()===
a.name.toLowerCase()&&b.clockRate===a.clockRate&&(b.preferredPayloadType=a.payloadType)})});l.headerExtensions.forEach(function(b){(a.remoteCapabilities&&a.remoteCapabilities.headerExtensions||[]).forEach(function(a){b.uri===a.uri&&(b.id=a.id)})});var k=a.sendEncodingParameters||[{ssrc:1001*(2*c+1)}];d&&(15019<=f&&"video"===e&&!k[0].rtx)&&(k[0].rtx={ssrc:k[0].ssrc+1});a.wantReceive&&(a.rtpReceiver=new g.RTCRtpReceiver(a.dtlsTransport,e));a.localCapabilities=l;a.sendEncodingParameters=k});"max-compat"!==
b._config.bundlePolicy&&(k+="a=group:BUNDLE "+b.transceivers.map(function(a){return a.mid}).join(" ")+"\r\n");k+="a=ice-options:trickle\r\n";b.transceivers.forEach(function(a,c){k+=d(a,a.localCapabilities,"offer",a.stream,b._dtlsRole);k+="a=rtcp-rsize\r\n";if(a.iceGatherer&&"new"!==b.iceGatheringState&&(0===c||!b.usingBundle))a.iceGatherer.getLocalCandidates().forEach(function(a){a.component=1;k+="a="+h.writeCandidate(a)+"\r\n"}),"completed"===a.iceGatherer.state&&(k+="a=end-of-candidates\r\n")});
a=new g.RTCSessionDescription({type:"offer",sdp:k});return Promise.resolve(a)};m.prototype.createAnswer=function(){var a=this;if(a._isClosed)return Promise.reject(e("InvalidStateError","Can not call createAnswer after close"));if(!("have-remote-offer"===a.signalingState||"have-local-pranswer"===a.signalingState))return Promise.reject(e("InvalidStateError","Can not call createAnswer in signalingState "+a.signalingState));var b=h.writeSessionBoilerplate(a._sdpSessionId,a._sdpSessionVersion++);a.usingBundle&&
(b+="a=group:BUNDLE "+a.transceivers.map(function(a){return a.mid}).join(" ")+"\r\n");var b=b+"a=ice-options:trickle\r\n",l=h.getMediaSections(a._remoteDescription.sdp).length;a.transceivers.forEach(function(e,g){if(!(g+1>l))if(e.rejected)"application"===e.kind?b="DTLS/SCTP"===e.protocol?b+"m=application 0 DTLS/SCTP 5000\r\n":b+("m=application 0 "+e.protocol+" webrtc-datachannel\r\n"):"audio"===e.kind?b+="m=audio 0 UDP/TLS/RTP/SAVPF 0\r\na=rtpmap:0 PCMU/8000\r\n":"video"===e.kind&&(b+="m=video 0 UDP/TLS/RTP/SAVPF 120\r\na=rtpmap:120 VP8/90000\r\n"),
b+="c=IN IP4 0.0.0.0\r\na=inactive\r\na=mid:"+e.mid+"\r\n";else{if(e.stream){var h;"audio"===e.kind?h=e.stream.getAudioTracks()[0]:"video"===e.kind&&(h=e.stream.getVideoTracks()[0]);h&&(15019<=f&&"video"===e.kind&&!e.sendEncodingParameters[0].rtx)&&(e.sendEncodingParameters[0].rtx={ssrc:e.sendEncodingParameters[0].ssrc+1})}h=c(e.localCapabilities,e.remoteCapabilities);!h.codecs.filter(function(a){return"rtx"===a.name.toLowerCase()}).length&&e.sendEncodingParameters[0].rtx&&delete e.sendEncodingParameters[0].rtx;
b+=d(e,h,"answer",e.stream,a._dtlsRole);e.rtcpParameters&&e.rtcpParameters.reducedSize&&(b+="a=rtcp-rsize\r\n")}});var k=new g.RTCSessionDescription({type:"answer",sdp:b});return Promise.resolve(k)};m.prototype.addIceCandidate=function(a){var b=this,c;return a&&!(void 0!==a.sdpMLineIndex||a.sdpMid)?Promise.reject(new TypeError("sdpMLineIndex or sdpMid required")):new Promise(function(d,g){if(b._remoteDescription)if(!a||""===a.candidate)for(var f=0;f<b.transceivers.length&&(b.transceivers[f].rejected||
!(b.transceivers[f].iceTransport.addRemoteCandidate({}),c=h.getMediaSections(b._remoteDescription.sdp),c[f]+="a=end-of-candidates\r\n",b._remoteDescription.sdp=h.getDescription(b._remoteDescription.sdp)+c.join(""),b.usingBundle));f++);else{f=a.sdpMLineIndex;if(a.sdpMid)for(var k=0;k<b.transceivers.length;k++)if(b.transceivers[k].mid===a.sdpMid){f=k;break}var m=b.transceivers[f];if(m){if(m.rejected)return d();k=0<Object.keys(a.candidate).length?h.parseCandidate(a.candidate):{};if("tcp"===k.protocol&&
(0===k.port||9===k.port)||k.component&&1!==k.component)return d();if((0===f||0<f&&m.iceTransport!==b.transceivers[0].iceTransport)&&!l(m.iceTransport,k))return g(e("OperationError","Can not add ICE candidate"));m=a.candidate.trim();0===m.indexOf("a=")&&(m=m.substr(2));c=h.getMediaSections(b._remoteDescription.sdp);c[f]+="a="+(k.type?m:"end-of-candidates")+"\r\n";b._remoteDescription.sdp=h.getDescription(b._remoteDescription.sdp)+c.join("")}else return g(e("OperationError","Can not add ICE candidate"))}else return g(e("InvalidStateError",
"Can not add ICE candidate without a remote description"));d()})};m.prototype.getStats=function(a){if(a&&a instanceof g.MediaStreamTrack){var b=null;this.transceivers.forEach(function(c){c.rtpSender&&c.rtpSender.track===a?b=c.rtpSender:c.rtpReceiver&&c.rtpReceiver.track===a&&(b=c.rtpReceiver)});if(!b)throw e("InvalidAccessError","Invalid selector.");return b.getStats()}var c=[];this.transceivers.forEach(function(a){["rtpSender","rtpReceiver","iceGatherer","iceTransport","dtlsTransport"].forEach(function(b){a[b]&&
c.push(a[b].getStats())})});return Promise.all(c).then(function(a){var b=new Map;a.forEach(function(a){a.forEach(function(a){b.set(a.id,a)})});return b})};["RTCRtpSender","RTCRtpReceiver","RTCIceGatherer","RTCIceTransport","RTCDtlsTransport"].forEach(function(a){if((a=g[a])&&a.prototype&&a.prototype.getStats){var b=a.prototype.getStats;a.prototype.getStats=function(){return b.apply(this).then(function(a){var b=new Map;Object.keys(a).forEach(function(c){a[c].type={inboundrtp:"inbound-rtp",outboundrtp:"outbound-rtp",
candidatepair:"candidate-pair",localcandidate:"local-candidate",remotecandidate:"remote-candidate"}[a[c].type]||a[c].type;b.set(c,a[c])});return b})}}});var E=["createOffer","createAnswer"];E.forEach(function(a){var b=m.prototype[a];m.prototype[a]=function(){var a=arguments;return"function"===typeof a[0]||"function"===typeof a[1]?b.apply(this,[arguments[2]]).then(function(b){"function"===typeof a[0]&&a[0].apply(null,[b])},function(b){"function"===typeof a[1]&&a[1].apply(null,[b])}):b.apply(this,arguments)}});
E=["setLocalDescription","setRemoteDescription","addIceCandidate"];E.forEach(function(a){var b=m.prototype[a];m.prototype[a]=function(){var a=arguments;return"function"===typeof a[1]||"function"===typeof a[2]?b.apply(this,arguments).then(function(){"function"===typeof a[1]&&a[1].apply(null)},function(b){"function"===typeof a[2]&&a[2].apply(null,[b])}):b.apply(this,arguments)}});["getStats"].forEach(function(a){var b=m.prototype[a];m.prototype[a]=function(){var a=arguments;return"function"===typeof a[1]?
b.apply(this,arguments).then(function(){"function"===typeof a[1]&&a[1].apply(null)}):b.apply(this,arguments)}});return m}},{sdp:17}],17:[function(k,n,f){var d={generateIdentifier:function(){return Math.random().toString(36).substr(2,10)}};d.localCName=d.generateIdentifier();d.splitLines=function(a){return a.trim().split("\n").map(function(a){return a.trim()})};d.splitSections=function(a){return a.split("\nm=").map(function(a,b){return(0<b?"m="+a:a).trim()+"\r\n"})};d.getDescription=function(a){return(a=
d.splitSections(a))&&a[0]};d.getMediaSections=function(a){a=d.splitSections(a);a.shift();return a};d.matchPrefix=function(a,c){return d.splitLines(a).filter(function(a){return 0===a.indexOf(c)})};d.parseCandidate=function(a){a=0===a.indexOf("a=candidate:")?a.substring(12).split(" "):a.substring(10).split(" ");for(var c={foundation:a[0],component:parseInt(a[1],10),protocol:a[2].toLowerCase(),priority:parseInt(a[3],10),ip:a[4],address:a[4],port:parseInt(a[5],10),type:a[7]},b=8;b<a.length;b+=2)switch(a[b]){case "raddr":c.relatedAddress=
a[b+1];break;case "rport":c.relatedPort=parseInt(a[b+1],10);break;case "tcptype":c.tcpType=a[b+1];break;case "ufrag":c.ufrag=a[b+1];c.usernameFragment=a[b+1];break;default:c[a[b]]=a[b+1]}return c};d.writeCandidate=function(a){var c=[];c.push(a.foundation);c.push(a.component);c.push(a.protocol.toUpperCase());c.push(a.priority);c.push(a.address||a.ip);c.push(a.port);var b=a.type;c.push("typ");c.push(b);"host"!==b&&(a.relatedAddress&&a.relatedPort)&&(c.push("raddr"),c.push(a.relatedAddress),c.push("rport"),
c.push(a.relatedPort));a.tcpType&&"tcp"===a.protocol.toLowerCase()&&(c.push("tcptype"),c.push(a.tcpType));if(a.usernameFragment||a.ufrag)c.push("ufrag"),c.push(a.usernameFragment||a.ufrag);return"candidate:"+c.join(" ")};d.parseIceOptions=function(a){return a.substr(14).split(" ")};d.parseRtpMap=function(a){a=a.substr(9).split(" ");var c={payloadType:parseInt(a.shift(),10)};a=a[0].split("/");c.name=a[0];c.clockRate=parseInt(a[1],10);c.channels=3===a.length?parseInt(a[2],10):1;c.numChannels=c.channels;
return c};d.writeRtpMap=function(a){var c=a.payloadType;void 0!==a.preferredPayloadType&&(c=a.preferredPayloadType);var b=a.channels||a.numChannels||1;return"a=rtpmap:"+c+" "+a.name+"/"+a.clockRate+(1!==b?"/"+b:"")+"\r\n"};d.parseExtmap=function(a){a=a.substr(9).split(" ");return{id:parseInt(a[0],10),direction:0<a[0].indexOf("/")?a[0].split("/")[1]:"sendrecv",uri:a[1]}};d.writeExtmap=function(a){return"a=extmap:"+(a.id||a.preferredId)+(a.direction&&"sendrecv"!==a.direction?"/"+a.direction:"")+" "+
a.uri+"\r\n"};d.parseFmtp=function(a){for(var c={},b=a.substr(a.indexOf(" ")+1).split(";"),d=0;d<b.length;d++)a=b[d].trim().split("="),c[a[0].trim()]=a[1];return c};d.writeFmtp=function(a){var c="",b=a.payloadType;void 0!==a.preferredPayloadType&&(b=a.preferredPayloadType);if(a.parameters&&Object.keys(a.parameters).length){var d=[];Object.keys(a.parameters).forEach(function(b){a.parameters[b]?d.push(b+"="+a.parameters[b]):d.push(b)});c+="a=fmtp:"+b+" "+d.join(";")+"\r\n"}return c};d.parseRtcpFb=function(a){a=
a.substr(a.indexOf(" ")+1).split(" ");return{type:a.shift(),parameter:a.join(" ")}};d.writeRtcpFb=function(a){var c="",b=a.payloadType;void 0!==a.preferredPayloadType&&(b=a.preferredPayloadType);a.rtcpFeedback&&a.rtcpFeedback.length&&a.rtcpFeedback.forEach(function(a){c+="a=rtcp-fb:"+b+" "+a.type+(a.parameter&&a.parameter.length?" "+a.parameter:"")+"\r\n"});return c};d.parseSsrcMedia=function(a){var c=a.indexOf(" "),b={ssrc:parseInt(a.substr(7,c-7),10)},d=a.indexOf(":",c);-1<d?(b.attribute=a.substr(c+
1,d-c-1),b.value=a.substr(d+1)):b.attribute=a.substr(c+1);return b};d.parseSsrcGroup=function(a){a=a.substr(13).split(" ");return{semantics:a.shift(),ssrcs:a.map(function(a){return parseInt(a,10)})}};d.getMid=function(a){if(a=d.matchPrefix(a,"a=mid:")[0])return a.substr(6)};d.parseFingerprint=function(a){a=a.substr(14).split(" ");return{algorithm:a[0].toLowerCase(),value:a[1]}};d.getDtlsParameters=function(a,c){return{role:"auto",fingerprints:d.matchPrefix(a+c,"a=fingerprint:").map(d.parseFingerprint)}};
d.writeDtlsParameters=function(a,c){var b="a=setup:"+c+"\r\n";a.fingerprints.forEach(function(a){b+="a=fingerprint:"+a.algorithm+" "+a.value+"\r\n"});return b};d.parseCryptoLine=function(a){a=a.substr(9).split(" ");return{tag:parseInt(a[0],10),cryptoSuite:a[1],keyParams:a[2],sessionParams:a.slice(3)}};d.writeCryptoLine=function(a){return"a=crypto:"+a.tag+" "+a.cryptoSuite+" "+("object"===typeof a.keyParams?d.writeCryptoKeyParams(a.keyParams):a.keyParams)+(a.sessionParams?" "+a.sessionParams.join(" "):
"")+"\r\n"};d.parseCryptoKeyParams=function(a){if(0!==a.indexOf("inline:"))return null;a=a.substr(7).split("|");return{keyMethod:"inline",keySalt:a[0],lifeTime:a[1],mkiValue:a[2]?a[2].split(":")[0]:void 0,mkiLength:a[2]?a[2].split(":")[1]:void 0}};d.writeCryptoKeyParams=function(a){return a.keyMethod+":"+a.keySalt+(a.lifeTime?"|"+a.lifeTime:"")+(a.mkiValue&&a.mkiLength?"|"+a.mkiValue+":"+a.mkiLength:"")};d.getCryptoParameters=function(a,c){return d.matchPrefix(a+c,"a=crypto:").map(d.parseCryptoLine)};
d.getIceParameters=function(a,c){var b=d.matchPrefix(a+c,"a=ice-ufrag:")[0],f=d.matchPrefix(a+c,"a=ice-pwd:")[0];return!b||!f?null:{usernameFragment:b.substr(12),password:f.substr(10)}};d.writeIceParameters=function(a){return"a=ice-ufrag:"+a.usernameFragment+"\r\na=ice-pwd:"+a.password+"\r\n"};d.parseRtpParameters=function(a){for(var c={codecs:[],headerExtensions:[],fecMechanisms:[],rtcp:[]},b=d.splitLines(a)[0].split(" "),f=3;f<b.length;f++){var e=b[f],h=d.matchPrefix(a,"a=rtpmap:"+e+" ")[0];if(h){var h=
d.parseRtpMap(h),g=d.matchPrefix(a,"a=fmtp:"+e+" ");h.parameters=g.length?d.parseFmtp(g[0]):{};h.rtcpFeedback=d.matchPrefix(a,"a=rtcp-fb:"+e+" ").map(d.parseRtcpFb);c.codecs.push(h);switch(h.name.toUpperCase()){case "RED":case "ULPFEC":c.fecMechanisms.push(h.name.toUpperCase())}}}d.matchPrefix(a,"a=extmap:").forEach(function(a){c.headerExtensions.push(d.parseExtmap(a))});return c};d.writeRtpDescription=function(a,c){var b="",b=b+("m="+a+" "),b=b+(0<c.codecs.length?"9":"0"),b=b+" UDP/TLS/RTP/SAVPF ",
b=b+(c.codecs.map(function(a){return void 0!==a.preferredPayloadType?a.preferredPayloadType:a.payloadType}).join(" ")+"\r\n"),b=b+"c=IN IP4 0.0.0.0\r\n",b=b+"a=rtcp:9 IN IP4 0.0.0.0\r\n";c.codecs.forEach(function(a){b+=d.writeRtpMap(a);b+=d.writeFmtp(a);b+=d.writeRtcpFb(a)});var f=0;c.codecs.forEach(function(a){a.maxptime>f&&(f=a.maxptime)});0<f&&(b+="a=maxptime:"+f+"\r\n");b+="a=rtcp-mux\r\n";c.headerExtensions&&c.headerExtensions.forEach(function(a){b+=d.writeExtmap(a)});return b};d.parseRtpEncodingParameters=
function(a){var c=[],b=d.parseRtpParameters(a),f=-1!==b.fecMechanisms.indexOf("RED"),e=-1!==b.fecMechanisms.indexOf("ULPFEC"),h=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute}),g=0<h.length&&h[0].ssrc,k,h=d.matchPrefix(a,"a=ssrc-group:FID").map(function(a){return a.substr(17).split(" ").map(function(a){return parseInt(a,10)})});0<h.length&&(1<h[0].length&&h[0][0]===g)&&(k=h[0][1]);b.codecs.forEach(function(a){"RTX"===a.name.toUpperCase()&&
a.parameters.apt&&(a={ssrc:g,codecPayloadType:parseInt(a.parameters.apt,10)},g&&k&&(a.rtx={ssrc:k}),c.push(a),f&&(a=JSON.parse(JSON.stringify(a)),a.fec={ssrc:g,mechanism:e?"red+ulpfec":"red"},c.push(a)))});0===c.length&&g&&c.push({ssrc:g});var n=d.matchPrefix(a,"b=");n.length&&(n=0===n[0].indexOf("b=TIAS:")?parseInt(n[0].substr(7),10):0===n[0].indexOf("b=AS:")?950*parseInt(n[0].substr(5),10)-16E3:void 0,c.forEach(function(a){a.maxBitrate=n}));return c};d.parseRtcpParameters=function(a){var c={},b=
d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"cname"===a.attribute})[0];b&&(c.cname=b.value,c.ssrc=b.ssrc);b=d.matchPrefix(a,"a=rtcp-rsize");c.reducedSize=0<b.length;c.compound=0===b.length;a=d.matchPrefix(a,"a=rtcp-mux");c.mux=0<a.length;return c};d.parseMsid=function(a){var c=d.matchPrefix(a,"a=msid:");if(1===c.length)return a=c[0].substr(7).split(" "),{stream:a[0],track:a[1]};a=d.matchPrefix(a,"a=ssrc:").map(function(a){return d.parseSsrcMedia(a)}).filter(function(a){return"msid"===
a.attribute});if(0<a.length)return a=a[0].value.split(" "),{stream:a[0],track:a[1]}};d.parseSctpDescription=function(a){var c=d.parseMLine(a),b=d.matchPrefix(a,"a=max-message-size:"),f;0<b.length&&(f=parseInt(b[0].substr(19),10));isNaN(f)&&(f=65536);b=d.matchPrefix(a,"a=sctp-port:");if(0<b.length)return{port:parseInt(b[0].substr(12),10),protocol:c.fmt,maxMessageSize:f};if(0<d.matchPrefix(a,"a=sctpmap:").length)return a=d.matchPrefix(a,"a=sctpmap:")[0].substr(10).split(" "),{port:parseInt(a[0],10),
protocol:a[1],maxMessageSize:f}};d.writeSctpDescription=function(a,c){var b=[],b="DTLS/SCTP"!==a.protocol?["m="+a.kind+" 9 "+a.protocol+" "+c.protocol+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctp-port:"+c.port+"\r\n"]:["m="+a.kind+" 9 "+a.protocol+" "+c.port+"\r\n","c=IN IP4 0.0.0.0\r\n","a=sctpmap:"+c.port+" "+c.protocol+" 65535\r\n"];void 0!==c.maxMessageSize&&b.push("a=max-message-size:"+c.maxMessageSize+"\r\n");return b.join("")};d.generateSessionId=function(){return Math.random().toString().substr(2,
21)};d.writeSessionBoilerplate=function(a,c,b){c=void 0!==c?c:2;a=a?a:d.generateSessionId();return"v=0\r\no="+(b||"thisisadapterortc")+" "+a+" "+c+" IN IP4 127.0.0.1\r\ns=-\r\nt=0 0\r\n"};d.writeMediaSection=function(a,c,b,f){c=d.writeRtpDescription(a.kind,c);c+=d.writeIceParameters(a.iceGatherer.getLocalParameters());c+=d.writeDtlsParameters(a.dtlsTransport.getLocalParameters(),"offer"===b?"actpass":"active");c+="a=mid:"+a.mid+"\r\n";c=a.direction?c+("a="+a.direction+"\r\n"):a.rtpSender&&a.rtpReceiver?
c+"a=sendrecv\r\n":a.rtpSender?c+"a=sendonly\r\n":a.rtpReceiver?c+"a=recvonly\r\n":c+"a=inactive\r\n";a.rtpSender&&(b="msid:"+f.id+" "+a.rtpSender.track.id+"\r\n",c=c+("a="+b)+("a=ssrc:"+a.sendEncodingParameters[0].ssrc+" "+b),a.sendEncodingParameters[0].rtx&&(c+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" "+b,c+="a=ssrc-group:FID "+a.sendEncodingParameters[0].ssrc+" "+a.sendEncodingParameters[0].rtx.ssrc+"\r\n"));c+="a=ssrc:"+a.sendEncodingParameters[0].ssrc+" cname:"+d.localCName+"\r\n";a.rtpSender&&
a.sendEncodingParameters[0].rtx&&(c+="a=ssrc:"+a.sendEncodingParameters[0].rtx.ssrc+" cname:"+d.localCName+"\r\n");return c};d.getDirection=function(a,c){for(var b=d.splitLines(a),f=0;f<b.length;f++)switch(b[f]){case "a=sendrecv":case "a=sendonly":case "a=recvonly":case "a=inactive":return b[f].substr(2)}return c?d.getDirection(c):"sendrecv"};d.getKind=function(a){return d.splitLines(a)[0].split(" ")[0].substr(2)};d.isRejected=function(a){return"0"===a.split(" ",2)[1]};d.parseMLine=function(a){a=
d.splitLines(a)[0].substr(2).split(" ");return{kind:a[0],port:parseInt(a[1],10),protocol:a[2],fmt:a.slice(3).join(" ")}};d.parseOLine=function(a){a=d.matchPrefix(a,"o=")[0].substr(2).split(" ");return{username:a[0],sessionId:a[1],sessionVersion:parseInt(a[2],10),netType:a[3],addressType:a[4],address:a[5]}};d.isValidSDP=function(a){if("string"!==typeof a||0===a.length)return!1;a=d.splitLines(a);for(var c=0;c<a.length;c++)if(2>a[c].length||"="!==a[c].charAt(1))return!1;return!0};"object"===typeof n&&
(n.exports=d)},{}]},{},[1])(1)});"use strict";
var JCClient=function(k){function n(){function a(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return a()+a()+"-"+a()+"-"+a()+"-"+a()+"-"+a()+a()+a()}function f(){if(k.userid)return k.userid;var a=localStorage.getItem("userid");a||(a=n(),localStorage.setItem("userid",a));return a}function d(a,b,c){a:{for(var d=a.length,e=0;e<d;++e)if(0===a[e].indexOf(b)&&(!c||-1!==a[e].toLowerCase().indexOf(c.toLowerCase()))){a=e;break a}a=null}return a}function a(a,b,c,e){c=b+" "+c+" codec";
if(""===e)return console.log("No preference on "+c+"."),a;console.log("Prefer "+c+": "+e);c=a.split("\r\n");b=d(c,"m=",b);if(null===b)return a;a=(a=d(c,"a=rtpmap",e))?(a=c[a].match(/a=rtpmap:(\d+) \w+\/\d+/))&&2===a.length?a[1]:null:null;if(a){e=c[b].split(" ");var f=e.slice(0,3);f.push(a);for(var g=3;g<e.length;g++)e[g]!==a&&f.push(e[g]);a=f.join(" ");c[b]=a}return a=c.join("\r\n")}function c(a){a=a.replace(/b=AS([^\r\n]+\r\n)/g,"");B&&(a=a.replace(/a=mid:audio\r\n/g,"a=mid:audio\r\nb=AS:"+B+"\r\n"));
I&&(a=H?a.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+s+"\r\n"):a.replace(/a=mid:video\r\n/g,"a=mid:video\r\nb=AS:"+I+"\r\n"));G&&(a=a.replace(/a=mid:data\r\n/g,"a=mid:data\r\nb=AS:"+G+"\r\n"));return a}function b(a){var b=[];M?b.push({urls:"stun:stun.services.mozilla.com"}):b.push({urls:"stun:stun.l.google.com:19302"});a.turnIceServers&&(console.log("adding turnIceServers: "+JSON.stringify(a.turnIceServers)),b=b.concat(a.turnIceServers));return b={iceServers:b}}function l(){return{optional:[{DtlsSrtpKeyAgreement:!0}],
mandatory:{OfferToReceiveAudio:!0,OfferToReceiveVideo:!0}}}function e(a,b,c){c.onmessage=function(d){try{var e=JSON.parse(d.data);if("text"==e.type)console.log("onmessage text: "+JSON.stringify(e)),q("chatMessage",[b,e.msg]);else if("file"==e.type){var f=P[e.id];f||(f=P[e.id]={userid:b,fileName:e.fileName,mimeType:e.mimeType,file:createJCFile(e.fileName,e.mimeType)});f.file.appendBase64(e.data);q("fileProgress",[b,e.id,e.progress,e.sent,e.total]);e.done&&(f.file.finish(function(){q("fileAdded",[b,
e.id,f.file])}),delete P[e.id]);e.ack&&c.send(JSON.stringify({type:"file_ack",id:e.id}))}else if("file_ack"==e.type){var g=L[e.id];g&&(g.lastCount=g.lastCountStart,E(a,b,g))}else if("file_prompt"==e.type)console.log("onmessage file_prompt:"),q("filePrompt",[b,e.file,function(a){c.send(JSON.stringify({type:"file_prompt_answer",file:e.file,answer:a}))}]);else if("file_prompt_answer"==e.type)console.log("onmessage file_answer: "+JSON.stringify(e)),q("filePromptAnswer",[b,e.answer,e.file]),e.answer&&
a._sendFile(b,L[e.file.id]);else if("file_cancel"==e.type)a.cancelSendFiles(e.id,!0),q("fileCancel",[b,e.id]);else if("broadcast_state"==e.type)console.log("onmessage broadcast_state: "+JSON.stringify(e)),D[b].broadcastState=e.state,q("broadcastState",[b,e.state]);else if("update_name"==e.type)console.log("onmessage update_name: "+JSON.stringify(e)),D[b].name=e.name,q("updateName",[b,e.name]);else if("update_avatar"==e.type){console.log("onmessage update_avatar: "+b);var h=D[b];1==e.packetNum&&(h.avatarChunks=
[]);h.avatarChunks.push(e.avatar);e.maxPackets==e.packetNum&&(h.avatar=h.avatarChunks.join(""),console.log("got avatar "+h.avatar),delete h.avatarChunks,q("updateAvatar",[b,h.avatar]))}else"joined"==e.type?(console.log("onmessage joined: "+b),q("joined",[b])):"search"==e.type?(console.log("onmessage search: "+b),q("search",[b,e.q])):"data_message"==e.type&&(console.log("onmessage data_message: "+b),q("dataMessage",[b,e.msg]))}catch(k){console.log(k)}};c.onopen=function(){console.log("dc open");u(c,
v,y,null!=a.screenStream);c.send(JSON.stringify({type:"update_name",name:a.username()}));var b=a.avatar();m(c,b,function(){c.send(JSON.stringify({type:"joined"}))})};c.onclose=function(){console.log("dc close")};c.onerror=function(){console.log("dc error")}}function h(a,b){if("mcu"==a.roomSettings.mode)if("mcu"==b)c=r[b]=a.createPeerConnection(b);else{var c=r[b]=a.createPeerConnection(b),d=t[b]=c.createDataChannel("jumpchat");e(a,b,d)}else{var c;r[b]?(c=r[b],a.screenStream&&c.addStream(a.screenStream),
a.localStream&&(c.addStream(a.localStream),a.localStream2&&peer.addStream(this.localStream2))):c=r[b]=a.createPeerConnection(b);d=t[b]=c.createDataChannel("jumpchat");e(a,b,d)}p(a,c)}function g(a,b,c){a="hd"==a?{audio:!0,video:v?{mandatory:{minWidth:1280,minHeight:720}}:!1}:{audio:!0,video:v?{mandatory:{maxWidth:640,maxHeight:480}}:!1};b=b||localStorage.getItem("videoSourceId");c=c||localStorage.getItem("audioSourceId");b&&(a.video.optional=[{sourceId:b}]);c&&(a.audio={optional:[{sourceId:c}]});return a}
function p(b,d){var e="",f;for(f in r)if(d==r[f]){e=f;break}d.createOffer(function(f){console.log("offer created");f.sdp=c(f.sdp);f.sdp=a(f.sdp,"video","send","VP9");f.sdp=a(f.sdp,"video","receive","VP9");d.setLocalDescription(f,function(){var a={to:e,sdp:{type:d.localDescription.type,sdp:d.localDescription.sdp}};console.log("offer: "+JSON.stringify(a));b.socket.emit("webrtc",a)},console.error,l())},function(a){console.log(a)},l())}function N(a){var b="";a=a.getVideoTracks();a.length&&(b=a[0].label);
a=Z.filter(function(a){return a.label==b});0<a.length&&(aa=/THETA UVC/.test(a[0].label))}function C(a,b,c){N(b);var d=X?X:document.createElement("video");d.autoplay=!0;a.localStream=b;var e=a.localStream.getAudioTracks();0<e.length?e[0].enabled=y:y=!1;e=a.localStream.getVideoTracks();0<e.length?e[0].enabled=v:v=!1;b.me=a.localStream;d.autoplay=!0;d.muted=!0;c&&c(d);d.srcObject=b;X=d}function q(a,b){var c=R[a],d=new Event(a);b=b.slice(0);b.unshift(d);"function"==typeof c&&c.apply(d,b)}function m(a,
b,c){function d(){var h=b.slice(0,e);b=b.slice(e);a.send(JSON.stringify({type:"update_avatar",packetNum:g+1,avatar:h,maxPackets:f}));g++;0<b.length?setTimeout(d,100):c&&c()}var e=15E3,f=parseInt(b.length/e)+1,g=0;d()}function E(a,b,c){if(!c.cancel){for(var d=c.files[c.index],e=d.file.slice(c.offset,c.offset+c.sliceSize),f=new FileReader,g=0,h=0;h<c.index;h++)g+=c.files[h].size;f.readAsBinaryString(e);f.onloadend=function(){try{c.offset+=e.size;g+=c.offset;var h=btoa(f.result),k=parseInt(100*g/c.totalSize);
c.progress=k;t[b].send(JSON.stringify({type:"file",id:c.id,fileName:d.name,mimeType:d.type,ack:0==c.lastCount,progress:k,sent:g,total:c.total,done:e.size<c.sliceSize,data:h}));q("fileProgress",[b,c.id,k,g,c.totalSize]);c.lastCount--;0<=c.lastCount&&setTimeout(function(){E(a,b,c)},0)}catch(l){console.log(l)}e.size<c.sliceSize&&(c.index++,c.offset=0);c.index<c.files.length&&(c.sendAgain=!0)}}}function u(a,b,c,d){a&&a.send(JSON.stringify({type:"broadcast_state",state:{video:b,audio:c,screenShare:d}}))}
function A(a,b,c){null==U&&(U=setTimeout(function(){"stable"==b.signalingState||"have-local-offer"==b.signalingState?(console.log("_resetLocalStream startOffer()"),b.addStream(c),p(a,b),U=null):(console.log("_resetLocalStream waiting 500ms"),clearTimeout(U),U=null,A(a,b,c))},1E3))}function x(a,b){for(var c in r){var d=r[c];M&&(d.close(),r[c]=a.createPeerConnection(c));b?(!M&&a.localStream&&d.removeStream(a.localStream),p(a,d),A(a,d,a.screenStream)):(M||d.removeStream(a.screenStream),p(a,d),A(a,d,
a.localStream),a.screenStream=null)}}function V(a,b,c){var d=document.createElement("video");d.autoplay=!0;d.setAttribute("stream",a.id);b(d,c);d.srcObject=a}k=k||{};var w=k.serverName||"https://stage.jumpch.at",F=w+"/v1",D={},r={},t={},O={},Q={},P={},L={},W=!1,H=!1,B=k.audioBandwidth||50,I=k.videoBandwidth||300,s=k.videoBandwidthHD||2E3,G=k.dataBandwidth||3E6,Y=k.apiKey,z=!1,R={},J=!1,v=!1,y=!1,S=null,K="dpolibhkbcepgolajbfjfcakgdkfkfjg",T=!1,M=!!navigator.mozGetUserMedia,ba=navigator.userAgent.toLowerCase(),
ca=/android/.test(ba),Z=[],aa=!1,X=null;(function(a){M||ca||!window.chrome||!window.chrome.runtime?a(!1):chrome.runtime.sendMessage(K,{getVersion:!0},function(b){!b||!b.version?(console.warn("Extension not installed?: "+chrome.runtime.lastError),a(!1)):(console.log("Extension version is: "+b.version),a(!0))})})(function(a){T=a});window.localStorage&&(v=null==localStorage.getItem("broadcastVideo")||"true"==localStorage.getItem("broadcastVideo"),y=null==localStorage.getItem("broadcastAudio")||"true"==
localStorage.getItem("broadcastAudio"));this.attachMediaStream=function(a,b){a.srcObject=b};this.createPeerConnection=function(a){var c=b(this.roomSettings),d=new RTCPeerConnection(c),f=this;d.userid=a;if("mcu"!=this.roomSettings.mode||"mcu"==a)this.screenStream?d.addStream(this.screenStream):this.localStream&&(d.addStream(this.localStream),this.localStream2&&d.addStream(this.localStream2));d.onicecandidate=function(b){console.log("onicecandidate "+JSON.stringify(b.candidate));"mcu"==f.roomSettings.mode?
null==b.candidate?f.socket.emit("webrtc",{to:a.toString(),candidate:{completed:!0}}):f.socket.emit("webrtc",{to:a.toString(),candidate:b.candidate}):b.candidate&&f.socket.emit("webrtc",{to:a.toString(),candidate:b.candidate})};d.onaddstream=function(b){console.log("onaddstream");var c=b.stream,d=document.createElement("video");d.autoplay=!0;c[a]=c;d.setAttribute("stream",a);q("remoteVideoAdded",[a,c.id,d]);d.srcObject=c;d.autoplay=!0;0==b.stream.getVideoTracks().length&&q("broadcastState",[a,{video:!1,
audio:0<b.stream.getAudioTracks().length}])};d.onremovestream=function(b){console.log("remove stream");q("remoteVideoRemoved",[a,b.stream.id])};d.oniceconnectionstatechange=function(a){console.log("oniceconnectionstatechange = "+d.iceConnectionState)};d.onsignalingstatechange=function(b){console.log("onsignalingstatechange = "+d.signalingState);"closed"==d.signalingState&&(r[a]=null)};d.ondatachannel=function(b){console.log("got data channel");b=t[a]=b.channel;e(f,a,b)};Q[a]=[];return d};this.joinUrl=
function(a,b,c,d){var e=this;$.ajax({dataType:"json",url:a+"/settings",success:function(a){""!=a.serverUrl&&(F=a.serverUrl+"/v1");e.roomSettings=a;e._join(e.roomSettings.room,e.roomSettings.type,b,c,d)},headers:{"X-API-Key":Y},error:function(a,b,c){d(a.status,c)}})};this.join=function(a,b,c,d,e){var f=this;$.getJSON(w+"/api/1/settings/"+a,function(g){""!=g.serverUrl&&(F=g.serverUrl+"/v1");f.roomSettings=g;f._join(a,b,c,d,e)})};this._join=function(b,d,e,g,m){var n=this,p=io.connect(F,{"force new connection":k.forceNew});
this.socket=p;this.room=b;this.roomType=d;var s=f();this.userid=s;p.on("connect",function(){console.log("on_connect");p.emit("join",{room:b,userid:s,password:e,type:d,apiKey:Y,video_type:aa?"panoramic":"normal"});W=!0;"mcu"==n.roomSettings.mode&&h(n,"mcu")});p.on("disconnect",function(){console.log("on_disconnect")});p.on("users",function(a,b){console.log("users: "+JSON.stringify(a));n.sessid=b;for(var c in a){var d=a[c];D[d.userid]=d;"mcu"==n.roomSettings.mode&&b!=d.userid&&h(n,d.userid)}n.startBroadcasting();
g&&g(D)});p.on("joined",function(a){console.log("joined: "+JSON.stringify(a));var b=a.userid;D[b]=a;a.newUser=!0;h(n,b)});p.on("left",function(a){console.log("left: "+JSON.stringify(a));a=a.userid;if(void 0!=r[a]){q("remoteVideoRemoved",[a]);q("userLeft",[a]);delete D[a];var b=r[a];b&&b.close();delete r[a];delete t[a];delete O[a];var b=Object.keys(L),c;for(c in b){var d=b[c],e=L[d];e.userid==a&&(delete L[d],q("fileCancel",[a,d]))}b=Object.keys(P);for(c in b)d=b[c],e=P[d],e.userid==a&&(delete P[d],
q("fileCancel",[a,d]))}});p.on("room",function(a){S=a.password;q("room",[a]);console.log("room: "+JSON.stringify(a))});p.on("kicked",function(a){q("kicked",[a])});p.on("locked",function(a){q("locked",[a])});p.on("knocking",function(a){q("knocking",[a])});p.on("knockAnswer",function(a){q("knockAnswer",[a])});p.on("systemMessage",function(a){q("systemMessage",[a])});p.on("webrtc",function(b){console.log("webrtc: "+JSON.stringify(b));var d=b.from,e=r[d];e||(e=r[d]=n.createPeerConnection(d));b.candidate?
Q[d]?Q[d].push(b.candidate):(e=r[d],e.addIceCandidate(new RTCIceCandidate(b.candidate),function(){},function(a){console.error(a)})):b.sdp&&e.setRemoteDescription(new RTCSessionDescription(b.sdp),function(){console.log("remote desc set");"offer"==e.remoteDescription.type&&e.createAnswer(function(b){b.sdp=c(b.sdp);b.sdp=a(b.sdp,"video","send","H264/90000");b.sdp=a(b.sdp,"video","receive","H264/90000");e.setLocalDescription(b,function(){var a={to:d,sdp:{type:e.localDescription.type,sdp:e.localDescription.sdp}};
console.log("answer: "+JSON.stringify(a));p.emit("webrtc",a)},console.error)},console.error,l());n.drainCandidates(d,e)},function(a){console.error(a)})})};this.disconnect=function(){console.log("rtc.disconnect");this.socket&&this.socket.emit("leave");for(var a in r){q("remoteVideoRemoved",[a]);var b=r[a];b&&b.close();var c=O[a];if(c){for(var d=c.getAudioTracks(),b=0;b<d.length;b++)d[b].stop();c=c.getVideoTracks();for(b=0;b<c.length;b++)c[b].stop()}}D={};r={};t={};O={};W=!1;return!0};this.drainCandidates=
function(a,b){console.log("drain candidates "+a);var c=Q[a],d;for(d in c)b.addIceCandidate(new RTCIceCandidate(c[d]),function(){},function(a){console.error(a)});delete Q[a]};this.startBroadcasting=function(){console.log("start broadcasting");this.broadcasting=!0};this.stopBroadcasting=function(){this.broadcasting=!1;r={}};this.enableHD=function(a,b){if(void 0!=a&&"true"==localStorage.getItem("hd")!=a){localStorage.setItem("hd",a);this.localStream.getVideoTracks()[0].stop();this.localStream=null;var c=
this;this.localVideo(function(a){for(var d in r)a=r[d],a.removeStream(c.localStream),p(c,a),A(c,a,c.localStream);b&&b("true"==localStorage.getItem("hd"))})}return"true"==localStorage.getItem("hd")};this.enable2ndVideo=function(a,b){void 0!=a&&localStorage.getItem("video2")!=a&&localStorage.setItem("video2",a);return"true"==localStorage.getItem("video2")};this.resetLocalVideo=function(a){this.localStream&&1==this.localStream.getVideoTracks().length&&this.localStream.getVideoTracks()[0].stop();this.localStream=
null;var b=this;this.localVideo(function(c){for(var d in r)c=r[d],c.removeStream(b.localStream),p(b,c),A(b,c,b.localStream);a&&a()})};this.setAudioSourceId=function(a){null==a||""==a?localStorage.removeItem("audioSourceId"):localStorage.setItem("audioSourceId",a)};this.setVideoSourceId=function(a){null==a||""==a?localStorage.removeItem("videoSourceId"):localStorage.setItem("videoSourceId",a)};this.localVideo=function(a){var b=this;if(this.localStream)O.me=b.localStream,V(this.localStream,a,"local");
else{var c="true"==localStorage.getItem("hd")?"hd":"sd",d=g(c);navigator.mediaDevices.getUserMedia(d).then(function(d){H="hd"==c;C(b,d,a)}).catch(function(e){"hd"==c?(H=!1,d=g("sd"),navigator.mediaDevices.getUserMedia(d).then(function(c){C(b,c,a)}).catch(function(c){d.video=!1;navigator.mediaDevices.getUserMedia(d).then(function(c){v=!1;C(b,c,a)}).catch(function(b){v=y=!1;a&&a(null)})})):(d.video=!1,navigator.mediaDevices.getUserMedia(d).then(function(c){v=!1;C(b,c,a)}).catch(function(b){v=y=!1;a&&
a(null)}))})}};this.add2ndVideo=function(a,b){if(!this.localStream)return!1;var c="true"==localStorage.getItem("hd")?"hd":"sd",c=g(c);c.audio=!1;c.video.optional=[{sourceId:a}];var d=this;navigator.mediaDevices.getUserMedia(c).then(function(a){var c=document.createElement("video");c.autoplay=!0;c.muted=!0;b&&b(c);c.srcObject=a;d.localStream2=a;for(var e in r)c=r[e],c.addStream(a),p(d,c)}).catch(function(a){b(null)})};this.remove2ndVideo=function(){if(this.localStream2){for(var a in r){var b=r[a];
b.removeStream(this.localStream2);p(this,b)}this.localStream2=null}};this.on=function(a,b){R[a]=b};this.username=function(a){if(a||""==a){localStorage.setItem("username",a);for(var b in t)t[b].send(JSON.stringify({type:"update_name",name:a}))}return localStorage.getItem("username")||""};this.avatar=function(a){if(a){localStorage.setItem("avatar",a);for(var b in t)m(t[b],a);q("updateAvatar",["me",a])}return localStorage.getItem("avatar")||window.staticUrl+"img/default-avatar.png"};this.user=function(a){return"me"==
a?(a=this.sessid,a=D[a]||{},a.avatar=this.avatar(),a.name=this.username(),a):D[a]||{}};this.isSupported=function(){return null!=navigator.mediaDevices.getUserMedia};this.sendChatMessage=function(a,b){console.log("sending msg: "+a);if(b)t[b]&&t[b].send(JSON.stringify({type:"text",msg:a}));else for(var c in r)t[c]&&t[c].send(JSON.stringify({type:"text",msg:a}))};this.sendFiles=function(a,b){for(var c=[],d=[],e=[],f=0;f<b.length;f++)c.push(b[f].name),d.push(b[f].size),e.push(b[f]);e={id:n(),files:e,
userid:a};L[e.id]=e;t[a]&&t[a].send(JSON.stringify({type:"file_prompt",file:{id:e.id,names:c,sizes:d}}));return e.id};this.cancelSendFiles=function(a,b,c){var d=L[b];d&&(d.cancel=!0,delete L[b]);delete P[b];c||t[a]&&t[a].send(JSON.stringify({type:"file_cancel",id:b}))};this._sendFile=function(a,b){for(var c=0,d=0;d<b.files.length;d++)c+=b.files[d].size;b.totalSize=c;b.index=0;b.offset=0;b.sliceSize=15360*(2/3);b.lastCountStart=20;b.lastCount=b.lastCountStart;E(this,a,b)};this.stream=function(a){return"me"==
a?this.localStream:O[a]};this.peers=function(){return r};this.connected=function(){return W};this.users=function(){return D};this.admin=function(){var a=D[this.sessid];return a?a.admin:!1};this.broadcastAudio=function(a){if(null!=a){if(this.localStream){var b=this.localStream.getAudioTracks(),b=b.concat(this.screenStream?this.screenStream.getAudioTracks():[]);if(0<b.length){y=a;localStorage.setItem("broadcastAudio",y);for(a=0;a<b.length;a++)b[a].enabled=y}else y=!1}else y=!1;for(var c in r)u(t[c],
v,y,null!=this.screenStream);q("broadcastState",["me",{video:v,audio:y,screenShare:null!=this.screenStream}])}return y};this.broadcastVideo=function(a,b){if(!(v==a&&null==b)){if(null!=a){if(this.localStream){var c=this.localStream.getVideoTracks();v=a;localStorage.setItem("broadcastVideo",v);c[0]&&(c[0].enabled=v)}else this.screenStream?(v=a,this.screenStream.getVideoTracks()[0].enabled=v):v=!1;var c=null!=this.screenStream,d;for(d in r)u(t[d],v,y,c);q("broadcastState",["me",{video:v,audio:y,screenShare:c}])}return v}};
var U=null;this.isSharingScreen=function(){return z};this.shareScreen=function(a,b){function c(d,f){navigator.mediaDevices.getUserMedia(d).then(function(b){e.screenStream=b;if(f&&e.localStream){var c=e.localStream.getAudioTracks();c&&0<c.length&&(c=e.localStream.getAudioTracks()[0],b.addTrack(c))}b.getVideoTracks()[0].onended=function(){console.log("stream ended");e.shareScreen(a)};x(e,z);V(b,a,"screenshare");J=v;e.broadcastVideo(!0,!0)}).catch(function(a){z=!1;b(!1)})}function d(){if(M){var a=confirm("Do you want to share fullscreen?\n\nClick Ok to share full screen.\n\nClick Cancel to share windows.")?
"screen":"window";c({video:{mozMediaSource:a,mediaSource:a},audio:!0},!1)}else chrome.runtime.sendMessage(K,{getStream:!0},function(a){if(a)if(console.log("Response from extension: "+JSON.stringify(a)),a.streamId){var d={};d.video={mandatory:{chromeMediaSource:"desktop",chromeMediaSourceId:a.streamId,maxWidth:window.screen.width,maxHeight:window.screen.height,maxFrameRate:30}};c(d,!0)}else z=!1,b("Extension failed to get the stream");else b(chrome.runtime.lastError),T=!1})}z=!z;var e=this;if(z)e.isExtensionInstalled()?
d():q("noExtension");else{if(this.screenStream){var f=this.screenStream.getVideoTracks()[0];f.onended=null;f.stop()}x(this,z);this.localStream?(V(this.localStream,a,"local"),this.broadcastVideo(J)):this.broadcastVideo(!1)}};this.isExtensionInstalled=function(){M&&(T=0<document.querySelectorAll(".jcffExtInstalled").length);return T};this.installExtension=function(a,b){if(M)setTimeout(function(){alert("You will need to reload after installing the addon");window.location.reload()},5E3),window.location.href=
"https://addons.mozilla.org/firefox/downloads/latest/617104/addon-617104-latest.xpi";else{var c=this;chrome.webstore.install("https://chrome.google.com/webstore/detail/dpolibhkbcepgolajbfjfcakgdkfkfjg",function(d){console.log("Extension installed successfully",d);T=!0;setTimeout(function(){c.shareScreen(a,b)},1E3)},function(a){b(a);console.log("Failed to install the extension",a)})}};this.sendDebugLog=function(a,b,c){this.socket.emit("debug_log",{email:a,msg:b,ua:navigator.userAgent,log:c})};this.lockRoom=
function(a){this.socket.emit("lock",a)};this.knock=function(a){this.socket.emit("knock",{room:this.room,type:this.roomType,msg:a})};this.knockAnswer=function(a,b){this.socket.emit("knockAnswer",{sessid:a,answer:b})};this.password=function(){return S};this.kick=function(a){this.socket.emit("kick",a)};this.getSources=function(a){var b=null;navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices?b=function(a){navigator.mediaDevices.enumerateDevices().then(a).catch(function(){a([])})}:window.MediaStreamTrack&&
window.MediaStreamTrack.getSources?b=window.MediaStreamTrack.getSources.bind(window.MediaStreamTrack):window.MediaStreamTrack&&window.MediaStreamTrack.getMediaDevices&&(b=window.MediaStreamTrack.getMediaDevices.bind(window.MediaStreamTrack));b?b(function(b){a(b)}):a([])};this.doSearch=function(a){console.log("search msg: "+a);for(var b in r)t[b]&&t[b].send(JSON.stringify({type:"search",q:a}))};this.sendDataMessage=function(a,b){if(b)t[b]&&t[b].send(JSON.stringify({type:"data_message",msg:a}));else for(var c in r)t[c]&&
t[c].send(JSON.stringify({type:"data_message",msg:a}))};this.muteAudio=function(a,b){var c=O[a];c&&(c.getAudioTracks()[0].enable=!b)};this.muteVideo=function(a,b){var c=O[a];c&&(c.getVideoTracks()[0].enable=!b)};this.getSources(function(a){Z=a})},_fs;window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem;window.requestFileSystem&&window.requestFileSystem(window.TEMPORARY,26843545600,function(k){_fs=k},function(k){console.log(k)});
function createJCFile(k,n){return _fs?new JCFile(k,n):new JCFileMemory(k,n)}
function JCFile(k,n){this.queue=[];this.writing=!1;this.type=n;this.name=k;var f=this;_fs.root.getDirectory("jc",{create:!0},function(d){_fs.root.getFile("jc/"+k,{create:!0},function(a){f.fileEntry=a;a.createWriter(function(a){f.fileWriter=a;console.log('File "jc/'+k+'" created');a.truncate(0);a.onerror=function(a){console.log("Write failed: "+a.toString());error&&error(a)};a.onwriteend=function(){0!=a.length&&(f.queue.shift(),0==f.queue.length?f.writing=!1:f._write())}},function(a){console.log(a)})},
function(a){console.log(a)})},function(d){console.log(d)});this.append=function(d){d=new Blob([d],{type:this.type});this.appendBlob(d)};this.appendBase64=function(d){d=atob(d);for(var a=Array(d.length),c=0;c<d.length;c++)a[c]=d.charCodeAt(c);d=new Uint8Array(a);this.append(d)};this.appendBlob=function(d){this.queue.push(d);this.writing||this._write()};this._write=function(){var d=this;this.writing=!0;var a=this.queue[0];if(this.fileWriter)try{this.fileWriter.write(a)}catch(c){console.log("write failed"),
setTimeout(function(){d._write()},500)}else setTimeout(function(){d._write()},500)};this.saveAs=function(){var d=$("<a>").attr("download",this.name).attr("href",this.fileEntry.toURL());$(document.body).append(d);d[0].click();d.remove()};this.finish=function(d){var a=this;setTimeout(function(){a.writing?a.finish(d):d&&d()},500)}}
function JCFileMemory(k,n){this.data=[];this.type=n;this.name=k;this.append=function(f){this.data.push(f)};this.appendBase64=function(f){f=atob(f);for(var d=Array(f.length),a=0;a<f.length;a++)d[a]=f.charCodeAt(a);f=new Uint8Array(d);this.append(f)};this.appendBlob=function(f){var d=this,a=new FileReader;a.readAsBinaryString(f);a.onloadend=function(){d.data.push(a.result)}};this.saveAs=function(){var f=new Blob(this.data,{type:this.type});saveAs(f,this.name)};this.finish=function(f){f&&f()}};